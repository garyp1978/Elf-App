<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Jingles & Bells ‚Äî Daily Elf Message</title>
<style>
  :root{
    --bg1:#2a4a78; --bg2:#061024; --bg3:#02030a;
    --panel1:#1f3858; --panel2:#060b16;
    --msg1:#2b5175; --msg2:#071022;

    --white:#fff;
    --gold:#ffd972;
    --shadow: rgba(0,0,0,.55);
    --frame-red:#e04545;
    --frame-green:#209862;

    --btn-bg: rgba(255,255,255,.08);
    --btn-border: rgba(255,255,255,.18);

    --plain: system-ui,-apple-system,"Segoe UI",sans-serif;
    --hand: ui-rounded,"Bradley Hand","Comic Sans MS","Segoe Print",system-ui,sans-serif;

    --moodAccent: rgba(255,217,114,.25);
  }

  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{
    margin:0; min-height:100vh; font-family:var(--plain); color:var(--white);
    background: radial-gradient(circle at top, var(--bg1) 0, var(--bg2) 55%, var(--bg3) 100%);
    display:flex; justify-content:center; align-items:center;
    padding:14px; overflow:hidden;
    -webkit-user-select:none; user-select:none;
  }
  body.bigtext .msg{ font-size: clamp(1.45rem, 2.6vw + 1rem, 2.35rem); }
  body.bigtext .btnBig{ font-size:1.15rem; padding:16px 18px; }
  body.bigtext .chip, body.bigtext .btnG { font-size:.95rem; padding:12px 14px; }

  body.accessible{
    --bg1:#000; --bg2:#000; --bg3:#000;
    --panel1:#000; --panel2:#000;
    --msg1:#000; --msg2:#000;
    --btn-bg:#111; --btn-border:#fff;
  }

  .sky{
    position:fixed; inset:0; pointer-events:none; z-index:-6;
    background-image:
      radial-gradient(circle at 15% 20%, rgba(255,255,255,0.9) 1px, transparent 2px),
      radial-gradient(circle at 80% 35%, rgba(255,255,255,0.7) 1px, transparent 2px),
      radial-gradient(circle at 40% 80%, rgba(255,255,255,0.6) 1px, transparent 2px),
      radial-gradient(circle at 60% 10%, rgba(255,255,255,0.6) 1px, transparent 2px);
    background-size: 180px 180px, 220px 220px, 260px 260px, 300px 300px;
    animation: twinkle 16s linear infinite alternate;
    opacity:.45;
  }
  @keyframes twinkle{ 0%{opacity:.28; transform:translateY(0)} 50%{opacity:.72; transform:translateY(-8px)} 100%{opacity:.4; transform:translateY(6px)} }

  .snow{
    position:fixed; inset:0; pointer-events:none; z-index:-5;
    opacity: var(--snowOpacity, .55);
    background-image:
      radial-gradient(circle, rgba(255,255,255,0.6) 1px, transparent 2px),
      radial-gradient(circle, rgba(255,255,255,0.25) 1px, transparent 2px);
    background-size: var(--snowA, 140px) var(--snowA, 140px), var(--snowB, 220px) var(--snowB, 220px);
    background-position:0 0,60px 80px;
    animation:snowMove 22s linear infinite;
  }
  @keyframes snowMove{ from{transform:translateY(-20px)} to{transform:translateY(20px)} }

  .ground{
    position:fixed; left:-10%; right:-10%; bottom:-60px; height:160px; z-index:-3;
    background: radial-gradient(circle at top,#fdfefe 0,#d0dde8 45%,rgba(0,0,0,0) 70%);
    opacity:.9;
    pointer-events:none;
  }

  .wrap{width:100%;max-width:1020px}
  .board{
    position:relative;
    border-radius:28px;
    padding:20px 18px 16px;
    overflow:hidden;
    background: radial-gradient(circle at top, var(--panel1) 0, var(--panel2) 65%);
    border:6px solid #fff;
    box-shadow:0 22px 50px var(--shadow);
  }
  .board:before{
    content:"";
    position:absolute; inset:10px; border-radius:22px; padding:3px;
    background:repeating-linear-gradient(135deg,var(--frame-red) 0 14px,var(--frame-green) 14px 28px);
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;
    mask-composite:exclude;
    pointer-events:none;
    opacity:.92;
  }

  /* Hidden access zones */
  #secret-zone{ position:absolute; top:0; right:0; width:180px; height:180px; z-index:50; }
  #panic-zone{ position:absolute; bottom:0; left:0; width:130px; height:130px; z-index:50; }

  .hdr{ display:flex; gap:14px; align-items:center; margin-bottom:10px; }
  .face{ width:84px; height:84px; flex:0 0 auto; filter:drop-shadow(0 10px 14px rgba(0,0,0,.35)); }
  .title{ font-weight:950; letter-spacing:.10em; text-transform:uppercase; font-size:.9rem; color:var(--gold); }
  .sub{ font-size:1.55rem; font-weight:950; margin-top:2px; text-shadow:0 1px 4px rgba(0,0,0,.7) }
  .date{ font-size:.92rem; opacity:.9; margin-top:4px; }

  .meta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:6px 10px; border-radius:999px;
    background: rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.22);
    font-size:.85rem; font-weight:850;
    white-space:nowrap;
  }
  .pill b{ color:var(--gold); }

  .moodPill{
    background: var(--moodAccent);
    border-color: rgba(255,217,114,.45);
    position:relative;
    overflow:hidden;
  }
  .moodPill::after{
    content:"";
    position:absolute; inset:-40%;
    background: radial-gradient(circle at 20% 30%, rgba(255,255,255,.24), transparent 55%);
    transform: rotate(12deg);
    animation: moodGlow 3.5s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes moodGlow{
    0%{transform:translateX(-10px) rotate(12deg);opacity:.4}
    50%{transform:translateX(12px) rotate(12deg);opacity:.8}
    100%{transform:translateX(-10px) rotate(12deg);opacity:.4}
  }

  .msgbox{
    margin-top:10px;
    border-radius:22px;
    padding:22px 16px 14px;
    position:relative;
    overflow:hidden;
    background: radial-gradient(circle at top, var(--msg1) 0, var(--msg2) 70%);
    border:2px solid rgba(255,255,255,.2);
    box-shadow: inset 0 0 40px rgba(0,0,0,.55);
  }
  .garland{
    position:absolute; top:-14px; left:-16px; right:-16px; height:44px;
    pointer-events:none; opacity:.95;
    background-image:
      radial-gradient(circle,#ffef9a 3px,transparent 4px),
      radial-gradient(circle,#ff8080 3px,transparent 4px),
      radial-gradient(circle,#8ae6ff 3px,transparent 4px),
      radial-gradient(circle,#b5ff9a 3px,transparent 4px);
    background-size:70px 40px;
    background-position:0 22px,20px 12px,40px 26px,10px 6px;
    filter:drop-shadow(0 2px 6px rgba(0,0,0,.35));
  }
  .garland.twinkle{ animation: garlandBlink 1.2s steps(2,end) infinite; }
  @keyframes garlandBlink{
    0%{ opacity:.65; filter:drop-shadow(0 2px 6px rgba(0,0,0,.25)); }
    50%{ opacity:1; filter:drop-shadow(0 2px 12px rgba(255,255,255,.35)); }
    100%{ opacity:.8; }
  }

  .label{
    position:relative; z-index:2;
    font-size:.78rem;
    text-transform:uppercase;
    letter-spacing:.18em;
    opacity:.95;
    margin-bottom:10px;
    display:flex; justify-content:space-between; gap:10px;
    text-shadow:0 2px 10px rgba(0,0,0,.65);
  }
  .stamp{
    padding:5px 10px;
    border-radius:999px;
    background: rgba(255,217,114,.16);
    border:1px solid rgba(255,217,114,.45);
    font-weight:950;
    font-size:.68rem;
    letter-spacing:.10em;
  }

  .msg{
    margin:0;
    white-space:pre-wrap;
    line-height:1.45;
    font-weight:900;
    text-shadow:0 1px 2px rgba(0,0,0,.75),0 0 20px rgba(255,255,255,.18);
    font-size: clamp(1.2rem, 2vw + 1rem, 2rem);
    position:relative;
    z-index:2;
  }
  .msg.hand{ font-family: var(--hand); }

  .btnBig{
    margin-top:10px;
    width:100%;
    padding:14px 18px;
    border-radius:16px;
    border:none;
    background: linear-gradient(135deg,#22b36d,#178651);
    color:#fff;
    font-weight:1000;
    font-size:1.05rem;
    cursor:pointer;
    box-shadow:0 12px 26px rgba(0,0,0,.35);
  }
  .btnBig.alt{ background: linear-gradient(135deg,#4aa6ff,#2e63ff); }
  .btnBig.gray{ background: linear-gradient(135deg,#7a8496,#4b5363); }

  .card{
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    padding:12px;
  }
  .card h3{
    margin:0 0 6px 0;
    font-size:.88rem;
    letter-spacing:.10em;
    text-transform:uppercase;
    color: rgba(255,255,255,.9);
  }
  .card p{ margin:0; font-weight:850; opacity:.95; line-height:1.35; }
  .small{ font-size:.86rem; opacity:.85; }

  .row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .chip{
    padding:10px 14px;
    border-radius:999px;
    border:1px solid var(--btn-border);
    background: var(--btn-bg);
    color:#fff;
    font-weight:950;
    font-size:.78rem;
    text-transform:uppercase;
    cursor:pointer;
  }
  .chip.on{ background: rgba(255,217,114,.18); border-color: rgba(255,217,114,.55); }
  .chip:disabled{ opacity:.55; cursor:not-allowed; }

  .miniRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .miniRow > * { flex:1; min-width:180px; }
  input[type="range"]{ width:100%; }

  .stickers{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
  .st{
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    font-weight:950;
    font-size:.9rem;
  }

  .backdrop{
    position:fixed; inset:0;
    background: rgba(2,6,16,.78);
    display:none;
    align-items:center;
    justify-content:center;
    padding:14px;
    z-index:999;
  }
  .backdrop.visible{ display:flex; }

  .panel{
    width:100%;
    max-width:1000px;
    background: #071220;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.12);
    box-shadow:0 18px 40px rgba(0,0,0,.7);
    padding:14px;
    color:#f5f7fb;
    max-height: calc(100vh - 28px);
    overflow:auto;
    -webkit-user-select:text;
    user-select:text;
  }

  .panelHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .panelHeader h2{
    margin:0;
    font-size:1rem;
    letter-spacing:.10em;
    text-transform:uppercase;
    font-weight:950;
  }

  .btnG{
    font-size:1rem;
    padding:12px 16px;
    border-radius:14px;
    border:1px solid var(--btn-border);
    background: var(--btn-bg);
    color:#fff;
    font-weight:1000;
    cursor:pointer;
  }
  .btnG.primary{ background: linear-gradient(135deg,#22b36d,#178651); border:none; }
  .btnG.danger{ background: rgba(224,69,69,.18); border-color: rgba(224,69,69,.35); }

  label{ display:block; font-weight:900; margin:10px 0 6px; opacity:.95; }
  textarea, input, select{
    width:100%;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.22);
    padding:10px 12px;
    font-family:inherit;
    font-size:1rem;
    background:#050b15;
    color:#fff;
    outline:none;
  }
  textarea{ min-height:110px; resize:vertical; }

  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width: 720px){ .grid2{ grid-template-columns:1fr; } }

  /* Jumping Elf game */
  .toolbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.05);
    margin-bottom:10px;
  }
  .hud{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    font-weight:950; letter-spacing:.06em;
    font-size:.78rem; text-transform:uppercase;
  }
  .pill2{
    padding:7px 10px;
    border-radius:999px;
    background: rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,.18);
    white-space:nowrap;
  }
  .controls{ display:flex; gap:10px; flex-wrap:wrap; }

  canvas#game{
    display:block;
    width:100%;
    height:360px;
    background: linear-gradient(180deg, rgba(20,55,90,.55), rgba(0,0,0,.35));
    border-radius:14px;
    border:1px solid rgba(255,255,255,.15);
    touch-action:none;
  }
  body.zoomed canvas#game{ height:460px; }

  /* Other game canvases */
  canvas.gameCanvas{
    display:block;
    width:100%;
    height:360px;
    background: linear-gradient(180deg, rgba(20,55,90,.55), rgba(0,0,0,.35));
    border-radius:14px;
    border:1px solid rgba(255,255,255,.15);
    touch-action:none;
  }
  body.zoomed canvas.gameCanvas{ height:460px; }

  .status{
    margin-top:10px;
    text-align:center;
    font-weight:1000;
    letter-spacing:.04em;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.22);
  }
  .status b{ color: var(--gold); }

  /* Wheel */
  .wheelWrap{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:8px; }
  .wheel{
    width:min(360px, 80vw);
    height:min(360px, 80vw);
    border-radius:50%;
    border:8px solid rgba(255,255,255,.85);
    box-shadow: 0 18px 40px rgba(0,0,0,.55);
    position:relative;
    background:
      conic-gradient(
        rgba(255,217,114,.95) 0 45deg,
        rgba(74,166,255,.95) 45deg 90deg,
        rgba(34,179,109,.95) 90deg 135deg,
        rgba(224,69,69,.95) 135deg 180deg,
        rgba(168,122,255,.95) 180deg 225deg,
        rgba(255,149,90,.95) 225deg 270deg,
        rgba(120,200,255,.95) 270deg 315deg,
        rgba(255,239,154,.95) 315deg 360deg
      );
    transform: rotate(var(--wheelRot, 0deg));
    transition: transform 3.3s cubic-bezier(.12,.88,.12,1);
    overflow:hidden;
  }
  .wheel::after{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(circle at 50% 50%, rgba(0,0,0,.15), transparent 55%),
      radial-gradient(circle at 50% 50%, rgba(255,255,255,.18), transparent 70%);
    pointer-events:none;
  }
  .wheelCenter{
    width:84px;height:84px;border-radius:50%;
    background: rgba(0,0,0,.35);
    border:2px solid rgba(255,255,255,.35);
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    display:flex; align-items:center; justify-content:center;
    font-weight:1000;
    letter-spacing:.08em;
    text-transform:uppercase;
    font-size:.8rem;
    text-align:center;
  }
  .pointer{
    width:0;height:0;
    border-left:16px solid transparent;
    border-right:16px solid transparent;
    border-bottom:26px solid rgba(255,255,255,.9);
    filter: drop-shadow(0 10px 10px rgba(0,0,0,.45));
  }

  /* Advent */
  .adventGrid{
    display:grid;
    grid-template-columns: repeat(6, 1fr);
    gap:10px;
    margin-top:10px;
  }
  @media (max-width: 720px){ .adventGrid{ grid-template-columns: repeat(4,1fr);} }
  .door{
    border-radius:14px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    padding:12px 10px;
    text-align:center;
    font-weight:1000;
    cursor:pointer;
    position:relative;
    min-height:54px;
    display:flex; align-items:center; justify-content:center;
  }
  .door.open{ background: rgba(255,217,114,.16); border-color: rgba(255,217,114,.45); }
  .door.locked{ opacity:.55; cursor:not-allowed; }
  .door small{ position:absolute; bottom:8px; left:0; right:0; opacity:.75; font-weight:900; font-size:.72rem; }

  /* Nice list hearts */
  .hearts{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .heart{ font-size:1.25rem; filter: drop-shadow(0 8px 10px rgba(0,0,0,.35)); }

  /* ===== Games Hub + Memory + Tree styles ===== */
  #gamesHubBackdrop .btnBig{ margin-top:8px; }
  .mmGrid{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
    margin-top:10px;
  }
  @media (max-width:720px){
    .mmGrid{ grid-template-columns: repeat(4,1fr); }
  }
  .mmCard{
    border-radius:16px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    min-height:72px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.7rem;
    font-weight:1000;
    cursor:pointer;
    position:relative;
    user-select:none;
  }
  .mmCard.revealed{
    background: rgba(255,217,114,.16);
    border-color: rgba(255,217,114,.45);
  }
  .mmCard.matched{
    background: rgba(34,179,109,.18);
    border-color: rgba(34,179,109,.45);
    cursor:default;
  }
  .mmCard .mmBack{ opacity:.95; }
  .mmCard .mmFace{
    position:absolute; inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    opacity:0;
    transform:scale(.96);
    transition: opacity .12s ease, transform .12s ease;
  }
  .mmCard.revealed .mmFace,
  .mmCard.matched .mmFace{
    opacity:1; transform:scale(1);
  }
  .mmCard.revealed .mmBack,
  .mmCard.matched .mmBack{ opacity:0; }

  .dtWrap{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:12px;
    margin-top:10px;
  }
  @media (max-width:720px){
    .dtWrap{ grid-template-columns: 1fr; }
  }
  .dtTree{
    position:relative;
    min-height:360px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.05);
    overflow:hidden;
  }
  .dtTree::before{
    content:"";
    position:absolute; left:50%; top:55%;
    width:0; height:0;
    border-left:140px solid transparent;
    border-right:140px solid transparent;
    border-bottom:240px solid rgba(34,179,109,.45);
    transform:translate(-50%,-50%);
    filter: drop-shadow(0 18px 22px rgba(0,0,0,.25));
  }
  .dtTree::after{
    content:"";
    position:absolute; left:50%; bottom:26px;
    width:62px; height:56px;
    transform:translateX(-50%);
    border-radius:10px;
    background: rgba(120,74,40,.6);
    border:1px solid rgba(255,255,255,.12);
  }
  .dtTreeTop{
    position:absolute;
    left:50%; top:14px;
    transform:translateX(-50%);
    font-size:2rem;
    filter: drop-shadow(0 10px 12px rgba(0,0,0,.35));
  }
  .dtOrnaments{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    align-content:flex-start;
    padding:10px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
    min-height:200px;
  }
  .dtOrn{
    width:54px; height:54px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.08);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.8rem;
    cursor:grab;
    user-select:none;
  }
  .dtPlaced{
    position:absolute;
    width:44px; height:44px;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.45rem;
    background: rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.20);
    transform: translate(-50%,-50%);
    filter: drop-shadow(0 12px 14px rgba(0,0,0,.35));
  }

  /* Debug line for canvas size */
  .dbg { display:none; margin-top:10px; font-size:.8rem; opacity:.8; }
  .dbg.on { display:block; }
</style>
</head>

<body>
<div class="sky"></div>
<div class="snow" id="snowLayer"></div>
<div class="ground"></div>

<div class="wrap">
  <div class="board" id="board">
    <div id="secret-zone" aria-hidden="true"></div>
    <div id="panic-zone" aria-hidden="true"></div>

    <div class="hdr">
      <div class="face" aria-hidden="true">
        <svg viewBox="0 0 160 160" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="hat" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#20c06c"/>
              <stop offset="1" stop-color="#0c6b3a"/>
            </linearGradient>
          </defs>
          <path d="M40 65 C55 20, 115 20, 120 70 C104 62, 75 58, 40 65Z" fill="url(#hat)"/>
          <rect x="36" y="63" width="92" height="14" rx="7" fill="#f2f5f7"/>
          <circle cx="122" cy="75" r="8" fill="#ffd972"/>
          <ellipse cx="80" cy="95" rx="40" ry="34" fill="#ffd9b4"/>
          <circle cx="64" cy="92" r="6" fill="#1f2230"/>
          <circle cx="96" cy="92" r="6" fill="#1f2230"/>
          <path d="M65 110 C75 122, 85 122, 95 110" fill="none" stroke="#b55652" stroke-width="4" stroke-linecap="round"/>
        </svg>
      </div>

      <div style="flex:1;min-width:0">
        <div class="title">A Message From</div>
        <div class="sub">Jingles & Bells</div>
        <div class="date" id="dateLabel"></div>
        <div class="meta">
          <div class="pill">üéÅ Christmas in <b id="countdown">--</b></div>
          <div class="pill moodPill" id="moodPill">üôÇ Mood: <b id="moodText">--</b></div>
          <div class="pill">‚≠ê Stickers <b id="stickerCount">0</b></div>
          <div class="pill">üèÜ Daily best <b id="dailyBestMini">0</b></div>
          <div class="pill">ü™ô Coins <b id="coinsMini">0</b></div>
        </div>
      </div>
    </div>

    <div class="msgbox">
      <div class="garland" id="garland"></div>

      <div class="label">
        <span>Elf‚Äôs Note To Alexa</span>
        <span class="stamp" id="stamp">Official Elf Note</span>
      </div>

      <p class="msg" id="msg"></p>

      <button class="btnBig" id="openGamesHubFront" type="button">üïπÔ∏è Open Games Hub</button>
      <button class="btnBig alt" id="openExtras" type="button">‚ú® Fun & Extras</button>
    </div>
  </div>
</div>

<!-- Extras Popup -->
<div class="backdrop" id="extrasBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <h2>Fun & Extras</h2>
      <button class="btnG danger" id="closeExtras" type="button">‚úñ Close</button>
    </div>

    <div class="card">
      <h3>Jingles & Bells Mood</h3>
      <p>Today they‚Äôre feeling: <b id="moodText2">--</b></p>
      <p class="small" id="moodHint">‚Äî</p>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Spin The Wheel (1 per day)</h3>
      <p class="small">Win coins, stickers, or a little boost for the game.</p>
      <div class="row">
        <button class="chip" id="openWheel" type="button">üé° Open Wheel</button>
        <button class="chip" id="wheelStatus" type="button" disabled>Spin Available</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Advent Calendar (December only)</h3>
      <p class="small">Open today‚Äôs door (and past days) in December.</p>
      <div class="row">
        <button class="chip" id="openAdvent" type="button">üóìÔ∏è Open Advent</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Nice List</h3>
      <p class="small">Each kind thing adds a heart for today.</p>
      <div class="row">
        <button class="chip" id="addHeart" type="button">üíó I Did A Kind Thing</button>
        <button class="chip" id="resetHearts" type="button">Reset Hearts</button>
      </div>
      <div class="hearts" id="hearts"></div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Daily Challenge</h3>
      <p id="challengeText">---</p>
      <div class="row">
        <button class="chip" id="challengeDone" type="button">I Did It ‚úÖ</button>
        <button class="chip" id="challengeNew" type="button">New Challenge üîÅ</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Stickers</h3>
      <p class="small">Earn stickers from challenges, wheel prizes, and game milestones.</p>
      <div class="stickers" id="stickers"></div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Jokes & Riddles</h3>
      <div class="row">
        <button class="chip" id="jokeBtn" type="button">Joke ü§≠</button>
        <button class="chip" id="riddleBtn" type="button">Riddle üß©</button>
        <button class="chip" id="surpriseBtn" type="button">Surprise üéÅ</button>
      </div>
      <p id="funOutput" style="margin-top:10px">Tap a button to reveal something!</p>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Effects & Display</h3>
      <div class="row">
        <button class="chip" id="handBtn" type="button">Handwriting: Off</button>
        <button class="chip on" id="stampBtn" type="button">Stamp: On</button>
        <button class="chip on" id="twinkleBtn" type="button">Twinkle: On</button>
        <button class="chip on" id="snowBtn" type="button">Snow: On</button>
        <button class="chip" id="bigTextBtn" type="button">Big Text: Off</button>
        <button class="chip" id="accessBtn" type="button">Accessibility: Off</button>
        <button class="chip" id="perfBtn" type="button">Performance: Normal</button>
      </div>

      <div class="miniRow" style="margin-top:10px">
        <input id="snowRange" type="range" min="0" max="100" value="55"/>
        <div class="pill">‚ùÑÔ∏è <b id="snowVal">55</b>%</div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="chip" id="soundToggle" type="button">üîä Sound: On</button>
      </div>

      <p class="small">Parents/Admin is hidden: tap top-right 10 times. Panic close: triple tap bottom-left.</p>
    </div>
  </div>
</div>

<!-- Wheel Modal -->
<div class="backdrop" id="wheelBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:920px">
    <div class="panelHeader">
      <h2>Spin The Wheel</h2>
      <button class="btnG danger" id="closeWheel" type="button">‚úñ Close</button>
    </div>

    <div class="wheelWrap">
      <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
        <div class="pointer"></div>
        <div class="wheel" id="wheel">
          <div class="wheelCenter">Elf<br/>Wheel</div>
        </div>
      </div>

      <div style="min-width:min(360px,90vw);max-width:420px">
        <div class="card">
          <h3>Prize</h3>
          <p id="wheelResult">Tap ‚ÄúSpin‚Äù!</p>
          <p class="small" id="wheelNote">You can spin once per day.</p>
        </div>
        <div class="row" style="justify-content:center">
          <button class="btnG primary" id="spinBtn" type="button">üé° Spin</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Advent Modal -->
<div class="backdrop" id="adventBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:980px">
    <div class="panelHeader">
      <h2>Advent Calendar</h2>
      <button class="btnG danger" id="closeAdvent" type="button">‚úñ Close</button>
    </div>
    <p class="small" id="adventHint">Open doors up to today‚Äôs date (December only).</p>
    <div class="adventGrid" id="adventGrid"></div>
    <div class="card" style="margin-top:10px">
      <h3>Surprise</h3>
      <p id="adventOut">Pick a door!</p>
    </div>
  </div>
</div>

<!-- Jumping Elf Game Popup -->
<div class="backdrop" id="gameBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="toolbar">
      <button class="btnG danger" id="closeGame" type="button">‚úñ Close</button>

      <div class="hud">
        <span class="pill2">Score: <span id="score">0</span></span>
        <span class="pill2">Level: <span id="level">1</span></span>
        <span class="pill2">Coins(run): <span id="coins">0</span></span>
        <span class="pill2">Daily Best: <span id="dailyBest">0</span></span>
        <span class="pill2">Lives: <span id="lives">‚ù§‚ù§‚ù§</span></span>
      </div>

      <div class="controls">
        <button class="btnG" id="zoomBtn" type="button">‚õ∂ Big Mode</button>
        <button class="btnG primary" id="startBtn" type="button">‚ñ∂ Start</button>
        <button class="btnG primary" id="jumpBtn" type="button" disabled>‚¨ÜÔ∏è Jump</button>
      </div>
    </div>

    <canvas id="game"></canvas>

    <div class="status" id="status">
      Tap <b>Start</b>, then tap the game (or <b>Jump</b>) to jump.
    </div>
  </div>
</div>

<!-- Games Hub -->
<div class="backdrop" id="gamesHubBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:980px">
    <div class="panelHeader">
      <h2>Games Hub</h2>
      <button class="btnG danger" id="closeGamesHub" type="button">‚úñ Close</button>
    </div>

    <div class="card">
      <h3>Pick a game</h3>
      <div class="row">
        <button class="btnBig" id="openJumpingElfFromHub" type="button">üßù Jumping Elf (Jingles & Bells)</button>

        <button class="btnBig alt" id="openGame1" type="button">üéÅ Present Catcher</button>
        <button class="btnBig" id="openGame2" type="button">üß† Memory Match</button>
        <button class="btnBig alt" id="openGame3" type="button">‚ùÑÔ∏è Snowball Pop</button>
        <button class="btnBig" id="openGame4" type="button">üç¨ Candy Cane Runner</button>
        <button class="btnBig gray" id="openGame5" type="button">üéÑ Decorate the Tree</button>
      </div>
      <p class="small" style="margin-top:10px">Tip: sound uses the main Sound toggle.</p>
    </div>
  </div>
</div>

<!-- GAME 1: Present Catcher -->
<div class="backdrop" id="presentBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <h2>üéÅ Present Catcher</h2>
      <button class="btnG danger" id="closePresent" type="button">‚úñ Close</button>
    </div>
    <div class="toolbar">
      <div class="hud">
        <span class="pill2">Score: <span id="pcScore">0</span></span>
        <span class="pill2">Misses: <span id="pcMiss">0</span>/3</span>
        <span class="pill2">Level: <span id="pcLevel">1</span></span>
        <span class="pill2">Best: <span id="pcBest">0</span></span>
      </div>
      <div class="controls">
        <button class="btnG primary" id="pcStart" type="button">‚ñ∂ Start</button>
      </div>
    </div>
    <canvas class="gameCanvas" id="pcCanvas"></canvas>
    <div class="status" id="pcStatus">Drag left/right to move. Catch üéÅ, don‚Äôt miss 3!</div>
  </div>
</div>

<!-- GAME 2: Memory Match -->
<div class="backdrop" id="memoryBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:980px">
    <div class="panelHeader">
      <h2>üß† Memory Match</h2>
      <button class="btnG danger" id="closeMemory" type="button">‚úñ Close</button>
    </div>

    <div class="toolbar">
      <div class="hud">
        <span class="pill2">Moves: <span id="mmMoves">0</span></span>
        <span class="pill2">Matches: <span id="mmMatches">0</span>/<span id="mmTotal">8</span></span>
        <span class="pill2">Time: <span id="mmTime">0</span>s</span>
        <span class="pill2">Best: <span id="mmBest">--</span></span>
      </div>
      <div class="controls">
        <button class="btnG primary" id="mmNew" type="button">üîÅ New Game</button>
        <button class="btnG" id="mmHard" type="button">Difficulty: Normal</button>
      </div>
    </div>

    <div class="mmGrid" id="mmGrid"></div>
    <div class="status" id="mmStatus">Find all the pairs!</div>
  </div>
</div>

<!-- GAME 3: Snowball Pop -->
<div class="backdrop" id="snowBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <h2>‚ùÑÔ∏è Snowball Pop</h2>
      <button class="btnG danger" id="closeSnow" type="button">‚úñ Close</button>
    </div>
    <div class="toolbar">
      <div class="hud">
        <span class="pill2">Score: <span id="spScore">0</span></span>
        <span class="pill2">Misses: <span id="spMiss">0</span>/5</span>
        <span class="pill2">Level: <span id="spLevel">1</span></span>
        <span class="pill2">Best: <span id="spBest">0</span></span>
      </div>
      <div class="controls">
        <button class="btnG primary" id="spStart" type="button">‚ñ∂ Start</button>
      </div>
    </div>
    <canvas class="gameCanvas" id="spCanvas"></canvas>
    <div class="status" id="spStatus">Tap snowballs to pop them. Avoid the green ‚ÄúGrinch‚Äù one!</div>
  </div>
</div>

<!-- GAME 4: Candy Cane Runner -->
<div class="backdrop" id="runnerBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <h2>üç¨ Candy Cane Runner</h2>
      <button class="btnG danger" id="closeRunner" type="button">‚úñ Close</button>
    </div>
    <div class="toolbar">
      <div class="hud">
        <span class="pill2">Score: <span id="crScore">0</span></span>
        <span class="pill2">Level: <span id="crLevel">1</span></span>
        <span class="pill2">Best: <span id="crBest">0</span></span>
      </div>
      <div class="controls">
        <button class="btnG primary" id="crStart" type="button">‚ñ∂ Start</button>
        <button class="btnG primary" id="crSwitch" type="button" disabled>‚¨ÜÔ∏é Switch Lane</button>
      </div>
    </div>
    <canvas class="gameCanvas" id="crCanvas"></canvas>
    <div class="status" id="crStatus">Tap Switch (or tap the game) to change lanes and avoid obstacles.</div>
  </div>
</div>

<!-- GAME 5: Decorate the Tree -->
<div class="backdrop" id="treeBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:980px">
    <div class="panelHeader">
      <h2>üéÑ Decorate the Tree</h2>
      <button class="btnG danger" id="closeTree" type="button">‚úñ Close</button>
    </div>

    <div class="toolbar">
      <div class="hud">
        <span class="pill2">Placed: <span id="dtPlaced">0</span></span>
        <span class="pill2">Time: <span id="dtTime">30</span>s</span>
        <span class="pill2">Best: <span id="dtBest">0</span></span>
      </div>
      <div class="controls">
        <button class="btnG primary" id="dtStart" type="button">‚ñ∂ Start</button>
        <button class="btnG" id="dtReset" type="button">üîÅ Reset</button>
      </div>
    </div>

    <div class="dtWrap">
      <div class="dtTree" id="dtTree">
        <div class="dtTreeTop">‚≠ê</div>
      </div>
      <div class="dtOrnaments" id="dtOrnaments" aria-label="Ornaments tray"></div>
    </div>

    <div class="status" id="dtStatus">Drag ornaments onto the tree (or tap an ornament) before time runs out!</div>
  </div>
</div>

<!-- PIN Modal -->
<div class="backdrop" id="pinBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:720px">
    <div class="panelHeader">
      <h2>Parents Only</h2>
      <button class="btnG danger" id="pinClose" type="button">Close</button>
    </div>
    <p class="small">Enter the PIN to open settings.</p>
    <div class="miniRow">
      <input id="pinInput" type="password" inputmode="numeric" maxlength="8" placeholder="PIN"/>
      <button class="btnG primary" id="pinOk" type="button">OK</button>
    </div>
    <div id="pinErr" style="margin-top:10px;color:#ffb3b3;font-weight:900;min-height:1.2em"></div>
    <p class="small">Hidden access: tap top-right 10 times. Panic close: triple tap bottom-left.</p>
  </div>
</div>

<!-- Admin Modal -->
<div class="backdrop" id="adminBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <h2>Jingles & Bells ‚Äî Settings</h2>
      <button class="btnG danger" id="adminClose" type="button">Close</button>
    </div>

    <label>Default message</label>
    <textarea id="adminMsg"></textarea>

    <div class="grid2">
      <div>
        <label>Set message for a date (YYYY-MM-DD)</label>
        <input id="schedDate" type="text" placeholder="2025-12-10"/>
      </div>
      <div>
        <label>Scheduled message text</label>
        <input id="schedText" type="text" placeholder="Your message from Jingles & Bells"/>
      </div>
    </div>

    <div class="miniRow" style="margin-top:10px">
      <button class="btnG primary" id="saveToday" type="button">Save Default Message</button>
      <button class="btnG primary" id="saveScheduled" type="button">Save Scheduled</button>
      <button class="btnG" id="clearScheduled" type="button">Clear Scheduled for Date</button>
    </div>

    <label>PIN (4‚Äì8 digits)</label>
    <div class="miniRow">
      <input id="newPin" type="password" inputmode="numeric" placeholder="New PIN"/>
      <button class="btnG primary" id="setPin" type="button">Change PIN</button>
    </div>

    <label>Export / Import</label>
    <p class="small">Export gives a copy/paste code. Import replaces current settings.</p>
    <div class="miniRow">
      <button class="btnG" id="exportBtn" type="button">Export</button>
      <button class="btnG danger" id="importBtn" type="button">Import</button>
    </div>
    <textarea id="backupBox" placeholder="Backup code appears here..."></textarea>

    <label>Admin actions</label>
    <div class="row" style="margin-top:6px">
      <button class="chip" id="resetDayBtn" type="button">Reset Today (challenge+stickers)</button>
      <button class="chip" id="factoryBtn" type="button" style="border-color:rgba(224,69,69,.45)">Factory Reset</button>
    </div>

    <p class="small">Admin auto-closes after 45 seconds of no activity.</p>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // Safe rounded-rect helper (no reliance on CanvasRenderingContext2D existing)
  function drawRoundedRect(ctx, x, y, w, h, r) {
    if (!ctx) return;
    if (typeof ctx.roundRect === "function") {
      ctx.beginPath();
      ctx.roundRect(x, y, w, h, r);
      return;
    }
    const rr = Math.min(r, w / 2, h / 2);
    ctx.beginPath();
    ctx.moveTo(x + rr, y);
    ctx.arcTo(x + w, y,     x + w, y + h, rr);
    ctx.arcTo(x + w, y + h, x,     y + h, rr);
    ctx.arcTo(x,     y + h, x,     y,     rr);
    ctx.arcTo(x,     y,     x + w, y,     rr);
    ctx.closePath();
  }

  // ===== On-screen error console (HTML Viewer Q) =====
  (function(){
    const box = document.createElement("div");
    box.id = "errBox";
    box.style.cssText = `
      position:fixed; left:10px; right:10px; bottom:10px; z-index:99999;
      background:rgba(0,0,0,.75); color:#fff; border:1px solid rgba(255,255,255,.2);
      border-radius:12px; padding:10px 12px; font: 12px/1.35 system-ui;
      max-height:30vh; overflow:auto; display:none;
    `;
    document.body.appendChild(box);

    const show = (msg) => {
      box.style.display = "block";
      box.innerHTML =
        `<b>App error:</b><br>${String(msg).replace(/</g,"&lt;")}` +
        "<hr style='opacity:.2'>" + box.innerHTML;
    };

    window.addEventListener("error", (e)=> show(e.message + " @ " + (e.filename||"") + ":" + (e.lineno||"") ));
    window.addEventListener("unhandledrejection", (e)=> show((e.reason && e.reason.message) ? e.reason.message : e.reason));
  })();

  // ===== Storage (safe fallback) =====
  let storageOK = true;
  const mem = {};
  try { localStorage.setItem("__t","1"); localStorage.removeItem("__t"); } catch { storageOK = false; }
  const get = (k, fb) => { try { return storageOK ? (localStorage.getItem(k) ?? fb) : (mem[k] ?? fb); } catch { return fb; } };
  const set = (k, v) => { try { storageOK ? localStorage.setItem(k, v) : (mem[k] = String(v)); } catch {} };

  const KEYS = {
    pin: "elf_pin_v4",
    msgDefault: "elf_msg_default_v4",
    msgByDate: "elf_msg_by_date_v4",
    hand: "elf_hand_v4",
    stamp: "elf_stamp_v4",
    twinkle: "elf_twinkle_v4",
    snowOn: "elf_snow_on_v4",
    snowPct: "elf_snow_pct_v4",
    bigText: "elf_bigtext_v4",
    access: "elf_access_v4",
    sound: "elf_sound_v4",

    dayKey: "elf_daykey_v4",
    challengeKey: "elf_challenge_v4",
    stickersKey: "elf_stickers_v4",

    dailyBestAll: "elf_dailybest_all_v4",  // unified daily best across ALL games
    coins: "elf_coins_v4",

    mood: "elf_mood_v4",
    wheelDay: "elf_wheel_day_v4",
    wheelDone: "elf_wheel_done_v4",

    hearts: "elf_hearts_v4",
    advent: "elf_advent_open_v4",

    perf: "elf_perf_v4",
  };

  // ===== Date helpers =====
  const pad2 = (n) => String(n).padStart(2,"0");
  const ymd = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const todayKey = () => ymd(new Date());

  // ===== Audio (WebAudio; iPad friendly after first tap) =====
  let soundOn = get(KEYS.sound, "1") !== "0";
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return null;
      audioCtx = new Ctx();
    }
    if(audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
    return audioCtx;
  }
  function beep(freq=660, ms=70, type="triangle"){
    if(!soundOn) return;
    const ctx = ensureAudio(); if(!ctx) return;
    const t0 = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.06, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);
    o.connect(g); g.connect(ctx.destination);
    o.start(t0); o.stop(t0 + ms/1000 + 0.03);
  }
  window.addEventListener("touchstart", ()=>ensureAudio(), {passive:true, once:true});
  window.addEventListener("mousedown", ()=>ensureAudio(), {once:true});
  function syncSoundButton(){
    $("soundToggle").textContent = soundOn ? "üîä Sound: On" : "üîá Sound: Off";
    set(KEYS.sound, soundOn ? "1" : "0");
  }

  // ===== Modal/canvas reliability helpers (HTML Viewer Q iPad fix) =====
  function forceLayout(){ document.body.offsetHeight; }
  function afterOpen(backdropEl, fn){
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        forceLayout();
        try { fn(); } catch (e) { console.log(e); }
      });
    });
  }

  async function fitCanvasSafe(canvasEl, tries = 20){
    let r = canvasEl.getBoundingClientRect();
    while ((r.width < 20 || r.height < 20) && tries-- > 0) {
      await new Promise(res => setTimeout(res, 80));
      forceLayout();
      r = canvasEl.getBoundingClientRect();
    }
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvasEl.width  = Math.max(1, Math.floor(r.width  * dpr));
    canvasEl.height = Math.max(1, Math.floor(r.height * dpr));
    const c = canvasEl.getContext("2d", { alpha: true });
    c.setTransform(dpr,0,0,dpr,0,0);
    canvasEl.style.touchAction = "none";
    return c;
  }

  // ===== Countdown =====
  function nextXmas(d){
    const y = d.getFullYear();
    const x = new Date(y,11,25,0,0,0,0);
    return d <= x ? x : new Date(y+1,11,25,0,0,0,0);
  }
  function tickCountdown(){
    const now = new Date();
    const x = nextXmas(now);
    const diff = x - now;
    if(diff <= 0){ $("countdown").textContent = "Merry Christmas!"; return; }
    const s = Math.floor(diff/1000);
    const days = Math.floor(s/86400);
    const hrs = Math.floor((s%86400)/3600);
    const mins = Math.floor((s%3600)/60);
    const secs = s%60;
    $("countdown").textContent = `${days}d ${hrs}h ${mins}m ${secs}s`;
  }

  // ===== Message scheduling =====
  function readMap(key){ try { return JSON.parse(get(key,"{}")) || {}; } catch { return {}; } }
  function writeMap(key, obj){ try { set(key, JSON.stringify(obj)); } catch {} }
  function getMessageForToday(){
    const t = todayKey();
    const map = readMap(KEYS.msgByDate);
    if(map[t]) return map[t];
    return get(KEYS.msgDefault,
      "Hello Alexa! üéÑ‚ú®\n\nToday‚Äôs mission from Jingles & Bells:\n‚Ä¢ Be kind\n‚Ä¢ Help someone\n‚Ä¢ Do your best listening\n\nLove,\nJingles & Bells üíö"
    );
  }
  function renderMessage(){ $("msg").textContent = getMessageForToday(); }

  // ===== Daily seed (challenge/stickers/hearts) =====
  const CHALLENGES = [
    "Find 3 red things in the house üéà","Do 10 star jumps ‚≠ê","Draw a snowman and show it to a grown-up ‚õÑ",
    "Say 3 kind things to someone üíõ","Make your bed like a tidy elf üõèÔ∏è","Help with one small job (shoes, toys, table) üßπ",
    "Sing a Christmas song (even a silly one!) üé∂","Write a thank-you note (or draw one) ‚úçÔ∏è","Read a story with someone üìö",
    "Make a reindeer face in the mirror ü¶å"
  ];
  const STICKERS = ["‚≠ê","üéÅ","üç¨","ü¶å","üéÑ","‚ùÑÔ∏è","‚ú®","üèÖ","üß∏","üéÖ","ü™ô","üíó"];

  function ensureDaily(){
    const t = todayKey();
    if(get(KEYS.dayKey,"") !== t){
      set(KEYS.dayKey, t);
      const pick = CHALLENGES[(Math.random()*CHALLENGES.length)|0];
      set(KEYS.challengeKey, JSON.stringify({ day:t, text:pick, done:false }));
      set(KEYS.stickersKey, JSON.stringify({ day:t, list:[] }));
      set(KEYS.hearts, JSON.stringify({ day:t, count:0 }));
      set(KEYS.wheelDay, t);
      set(KEYS.wheelDone, "0");
      // daily best is keyed per day in map; no need to clear here
    }
  }
  function readChallenge(){ ensureDaily(); try { return JSON.parse(get(KEYS.challengeKey,"{}"))||{}; } catch { return {}; } }
  function writeChallenge(o){ set(KEYS.challengeKey, JSON.stringify(o)); }
  function readStickers(){ ensureDaily(); try { return JSON.parse(get(KEYS.stickersKey,"{}"))||{day:todayKey(),list:[]}; } catch { return {day:todayKey(),list:[]}; } }
  function writeStickers(o){ set(KEYS.stickersKey, JSON.stringify(o)); }

  function addSticker(reason="Nice!"){
    const s = readStickers();
    if(s.day !== todayKey()){ ensureDaily(); return addSticker(reason); }
    const emoji = STICKERS[(Math.random()*STICKERS.length)|0];
    s.list.push(emoji);
    writeStickers(s);
    renderStickers();
    $("funOutput").textContent = `You earned a sticker ${emoji} ‚Äî ${reason}`;
    beep(920,70,"sine");
  }
  function renderStickers(){
    const s = readStickers();
    $("stickerCount").textContent = String(s.list.length);
    const box = $("stickers"); box.innerHTML="";
    s.list.slice(-24).forEach(e=>{
      const el=document.createElement("div"); el.className="st"; el.textContent=e; box.appendChild(el);
    });
  }
  function renderChallenge(){
    const c = readChallenge();
    $("challengeText").textContent = c.text || "Tap ‚ÄúNew Challenge‚Äù";
    $("challengeDone").textContent = c.done ? "Done ‚úÖ (Nice!)" : "I Did It ‚úÖ";
    $("challengeDone").classList.toggle("on", !!c.done);
  }

  // ===== Hearts =====
  function readHearts(){ ensureDaily(); try { return JSON.parse(get(KEYS.hearts,"{}"))||{day:todayKey(),count:0}; } catch { return {day:todayKey(),count:0}; } }
  function writeHearts(o){ set(KEYS.hearts, JSON.stringify(o)); }
  function renderHearts(){
    const h = readHearts();
    const box = $("hearts"); box.innerHTML="";
    for(let i=0;i<Math.min(24, h.count|0); i++){
      const d=document.createElement("div"); d.className="heart"; d.textContent="üíó"; box.appendChild(d);
    }
  }

  // ===== Mood (daily) =====
  const MOODS = [
    {name:"Silly", emoji:"üòú", accent:"rgba(255,149,90,.22)", hint:"Jingles & Bells might play a tiny prank today‚Ä¶"},
    {name:"Sneaky", emoji:"üïµÔ∏è", accent:"rgba(74,166,255,.20)", hint:"Extra sneaky footsteps today!"},
    {name:"Happy", emoji:"üòä", accent:"rgba(34,179,109,.20)", hint:"Super cheerful ‚Äî kindness time!"},
    {name:"Sleepy", emoji:"üò¥", accent:"rgba(168,122,255,.20)", hint:"Sleepy vibes ‚Äî whisper voices help!"},
    {name:"Sparkly", emoji:"‚ú®", accent:"rgba(255,217,114,.22)", hint:"Sparkly day ‚Äî try something creative!"}
  ];
  function hashStr(str){
    let h=2166136261>>>0;
    for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
    return h>>>0;
  }
  function getTodayMood(){
    const day = todayKey();
    const saved = get(KEYS.mood,"");
    if(saved){
      try{ const o=JSON.parse(saved); if(o && o.day===day) return o; }catch{}
    }
    const idx = hashStr(day + "|elfmood") % MOODS.length;
    const m = MOODS[idx];
    const out = { day, idx, ...m };
    set(KEYS.mood, JSON.stringify(out));
    return out;
  }
  function renderMood(){
    const m = getTodayMood();
    document.body.style.setProperty("--moodAccent", m.accent);
    $("moodText").textContent = `${m.emoji} ${m.name}`;
    $("moodText2").textContent = `${m.emoji} ${m.name}`;
    $("moodHint").textContent = m.hint;
  }

  // ===== Coins (global) =====
  function getCoins(){ return Math.max(0, parseInt(get(KEYS.coins,"0"),10)||0); }
  function setCoins(v){ set(KEYS.coins, String(Math.max(0,v|0))); }
  function addCoins(n, reason="Coins!"){
    const next = getCoins() + (n|0);
    setCoins(next);
    refreshMini();
    $("funOutput").textContent = `${reason} You got ü™ô +${n}!`;
    beep(980,55,"sine");
  }

  // ===== Unified Daily Best across ALL games =====
  function readNumMap(key){ try { return JSON.parse(get(key,"{}")) || {}; } catch { return {}; } }
  function writeNumMap(key, obj){ try { set(key, JSON.stringify(obj)); } catch {} }
  function getDailyBestAll(){
    const map = readNumMap(KEYS.dailyBestAll);
    return (map[todayKey()] || 0) | 0;
  }
  function setDailyBestAll(val){
    const map = readNumMap(KEYS.dailyBestAll);
    const t = todayKey();
    map[t] = Math.max(map[t]||0, val|0);
    writeNumMap(KEYS.dailyBestAll, map);
  }
  function refreshMini(){
    $("dailyBestMini").textContent = String(getDailyBestAll());
    $("coinsMini").textContent = String(getCoins());
  }

  // ===== Preferences =====
  function applyPrefs(){
    const hand = get(KEYS.hand,"0")==="1";
    const stampOn = get(KEYS.stamp,"1")!=="0";
    const twinkleOn = get(KEYS.twinkle,"1")!=="0";
    const snowOn = get(KEYS.snowOn,"1")!=="0";
    const snowPct = Math.max(0, Math.min(100, parseInt(get(KEYS.snowPct,"55"),10)||55));
    const big = get(KEYS.bigText,"0")==="1";
    const acc = get(KEYS.access,"0")==="1";
    const perf = get(KEYS.perf,"0")==="1";

    $("msg").classList.toggle("hand", hand);
    $("stamp").style.display = stampOn ? "inline-block" : "none";
    $("garland").classList.toggle("twinkle", twinkleOn && !perf);

    const snowLayer = $("snowLayer");
    snowLayer.style.display = (snowOn && !perf) ? "block" : "none";

    $("snowRange").value = String(snowPct);
    $("snowVal").textContent = String(snowPct);

    const a = 240 - Math.round(snowPct * 1.2);
    const b = 360 - Math.round(snowPct * 1.8);
    const op = 0.15 + (snowPct/100)*0.75;
    snowLayer.style.setProperty("--snowA", `${Math.max(60,a)}px`);
    snowLayer.style.setProperty("--snowB", `${Math.max(90,b)}px`);
    snowLayer.style.setProperty("--snowOpacity", String(op));

    $("handBtn").textContent = "Handwriting: " + (hand ? "On" : "Off");
    $("handBtn").classList.toggle("on", hand);

    $("stampBtn").textContent = "Stamp: " + (stampOn ? "On" : "Off");
    $("stampBtn").classList.toggle("on", stampOn);

    $("twinkleBtn").textContent = "Twinkle: " + (twinkleOn ? "On" : "Off");
    $("twinkleBtn").classList.toggle("on", twinkleOn);

    $("snowBtn").textContent = "Snow: " + (snowOn ? "On" : "Off");
    $("snowBtn").classList.toggle("on", snowOn);

    $("bigTextBtn").textContent = "Big Text: " + (big ? "On" : "Off");
    $("bigTextBtn").classList.toggle("on", big);

    $("accessBtn").textContent = "Accessibility: " + (acc ? "On" : "Off");
    $("accessBtn").classList.toggle("on", acc);

    $("perfBtn").textContent = "Performance: " + (perf ? "High" : "Normal");
    $("perfBtn").classList.toggle("on", perf);

    document.body.classList.toggle("bigtext", big);
    document.body.classList.toggle("accessible", acc);

    syncSoundButton();
  }

  // ===== Popup helpers =====
  const openBackdrop = (el) => { el.classList.add("visible"); el.setAttribute("aria-hidden","false"); requestAnimationFrame(()=>forceLayout()); };
  const closeBackdrop = (el) => { el.classList.remove("visible"); el.setAttribute("aria-hidden","true"); };
  const backdropClickClose = (el) => el.addEventListener("click",(e)=>{ if(e.target===el) closeBackdrop(el); });

  const extrasBackdrop = $("extrasBackdrop");
  const wheelBackdrop = $("wheelBackdrop");
  const adventBackdrop = $("adventBackdrop");
  const gameBackdrop = $("gameBackdrop");
  const pinBackdrop = $("pinBackdrop");
  const adminBackdrop = $("adminBackdrop");

  const gamesHubBackdrop = $("gamesHubBackdrop");
  const presentBackdrop = $("presentBackdrop");
  const memoryBackdrop = $("memoryBackdrop");
  const snowBackdrop = $("snowBackdrop");
  const runnerBackdrop = $("runnerBackdrop");
  const treeBackdrop = $("treeBackdrop");

  [extrasBackdrop,wheelBackdrop,adventBackdrop,gameBackdrop,pinBackdrop,adminBackdrop,
   gamesHubBackdrop,presentBackdrop,memoryBackdrop,snowBackdrop,runnerBackdrop,treeBackdrop].forEach(backdropClickClose);

  // ===== Wheel (1/day) =====
  const WHEEL = [
    {label:"ü™ô +10 coins", apply:()=>addCoins(10,"Wheel win!") },
    {label:"‚≠ê +1 sticker", apply:()=>addSticker("Wheel win!") },
    {label:"ü™ô +25 coins", apply:()=>addCoins(25,"Big wheel win!") },
    {label:"‚≠ê +2 stickers", apply:()=>{ addSticker("Wheel win!"); addSticker("Wheel win!"); } },
    {label:"üéÆ Jumping Elf boost: +1 life", apply:()=>{ gameBoost.life = 1; $("wheelNote").textContent="Next Jumping Elf starts with +1 life!"; } },
    {label:"üéÆ Jumping Elf boost: slow obstacles", apply:()=>{ gameBoost.slow = 1; $("wheelNote").textContent="Next Jumping Elf has slower obstacles!"; } },
    {label:"ü™ô +5 coins", apply:()=>addCoins(5,"Wheel win!") },
    {label:"‚≠ê Surprise sticker", apply:()=>addSticker("Surprise!") },
  ];
  function wheelDone(){ ensureDaily(); return get(KEYS.wheelDone,"0")==="1"; }
  function setWheelDone(v){ set(KEYS.wheelDone, v ? "1":"0"); }
  function renderWheelStatus(){
    const done = wheelDone();
    $("wheelStatus").textContent = done ? "Spin Used Today" : "Spin Available";
    $("wheelStatus").classList.toggle("on", !done);
    $("spinBtn").disabled = done;
  }

  let wheelRot = 0;

  // ===== Advent (December only) =====
  const ADVENT_SURPRISES = [
    "Jingles fact: Reindeer can see UV light! ü¶å",
    "Bells says: do 20 seconds of silly dancing üíÉ",
    "Bonus: ü™ô +5 coins!",
    "Bonus: ü™ô +10 coins!",
    "Bonus: ‚≠ê +1 sticker!",
    "Draw a candy cane ‚úçÔ∏è",
    "Tell someone one nice thing üíõ",
    "Make a paper snowflake ‚úÇÔ∏è‚ùÑÔ∏è",
    "Hide a tiny note for someone üìù",
    "Bonus: ‚≠ê +2 stickers!",
  ];
  function readAdvent(){ try { return JSON.parse(get(KEYS.advent, '{"open":[]}')) || {open:[]}; } catch { return {open:[]}; } }
  function writeAdvent(o){ set(KEYS.advent, JSON.stringify(o)); }
  function isDecemberNow(){ return new Date().getMonth() === 11; }
  function canOpenDoor(day){ return isDecemberNow() && day <= new Date().getDate(); }

  function renderAdventGrid(){
    const grid = $("adventGrid"); grid.innerHTML="";
    const data = readAdvent();
    const opened = new Set((data.open||[]).map(Number));
    const today = new Date().getDate();

    $("adventHint").textContent = isDecemberNow()
      ? "Open doors up to today‚Äôs date (December only)."
      : "Advent doors open in December only üéÑ";

    for(let d=1; d<=24; d++){
      const btn = document.createElement("button");
      btn.type="button";
      btn.className="door";
      btn.textContent = String(d);

      const ok = canOpenDoor(d);
      if(!ok) btn.classList.add("locked");
      if(opened.has(d)) btn.classList.add("open");

      const s = document.createElement("small");
      s.textContent = opened.has(d) ? "Opened" : (ok ? "Tap" : "Locked");
      btn.appendChild(s);

      btn.addEventListener("click", ()=>{
        if(!ok){ beep(180,120,"square"); return; }
        if(!opened.has(d)){
          opened.add(d);
          writeAdvent({open:[...opened].sort((a,b)=>a-b)});
        }
        const idx = (hashStr(todayKey()+"|door|"+d) % ADVENT_SURPRISES.length);
        const prize = ADVENT_SURPRISES[idx];
        $("adventOut").textContent = `Door ${d}: ${prize}`;

        if(prize.includes("+5 coins")) addCoins(5,"Advent bonus!");
        if(prize.includes("+10 coins")) addCoins(10,"Advent bonus!");
        if(prize.includes("+1 sticker")) addSticker("Advent bonus!");
        if(prize.includes("+2 stickers")) { addSticker("Advent bonus!"); addSticker("Advent bonus!"); }

        renderAdventGrid();
        beep(920,60,"sine");
      });

      grid.appendChild(btn);
    }
    $("adventOut").textContent = isDecemberNow() ? `Pick a door! (Today is ${today})` : "It‚Äôs not December yet ‚Äî doors are locked üéÑ";
  }

  // ===== Fun buttons =====
  const JOKES = [
    "What do elves learn in school? The elf-abet! üéì",
    "Why did the ornament go to school? To get a little brighter! ‚ú®",
    "What do snowmen eat for breakfast? Ice Krispies! ü•£",
    "Why is Santa so good at karate? He has a black belt! ü•ã",
    "What do you call a cat on the beach at Christmas? Sandy Claws! üêæ"
  ];
  const RIDDLES = [
    {q:"I‚Äôm full of holes but I can still hold water. What am I?", a:"A sponge üßΩ"},
    {q:"What has to be broken before you can use it?", a:"An egg ü•ö"},
    {q:"What has hands but can‚Äôt clap?", a:"A clock ‚è∞"},
    {q:"What goes up but never comes down?", a:"Your age üéÇ"},
  ];
  const SURPRISES = [
    "Jingles says: do a tiny happy dance! üíÉ",
    "Bells says: find something green! üíö",
    "Jingles says: tell someone ‚Äúthank you‚Äù! üôè",
    "Bells says: make a funny face! üòú",
    "Jingles says: tip-toe like an elf for 10 steps! üßù",
  ];

  // ===== Hidden admin access =====
  if(!get(KEYS.pin,"")) set(KEYS.pin,"1234");

  let secretTaps = 0;
  let secretTimer = 0;

  function showPinPanel(){
    $("pinInput").value = "";
    $("pinErr").textContent = "";
    openBackdrop(pinBackdrop);
    setTimeout(()=>{ try{$("pinInput").focus();}catch{} }, 120);
  }
  function showAdmin(){
    $("adminMsg").value = get(KEYS.msgDefault, "");
    $("backupBox").value = "";
    openBackdrop(adminBackdrop);
    adminArmTimeout();
  }

  $("secret-zone").addEventListener("click", ()=>{
    secretTaps++;
    clearTimeout(secretTimer);
    secretTimer = setTimeout(()=>secretTaps=0, 1200);
    if(secretTaps >= 10){
      secretTaps = 0;
      beep(880,70,"sine");
      showPinPanel();
    }
  });

  let panicCount = 0, panicTimer=0;
  $("panic-zone").addEventListener("click", ()=>{
    panicCount++;
    clearTimeout(panicTimer);
    panicTimer = setTimeout(()=>panicCount=0, 900);
    if(panicCount >= 3){
      panicCount = 0;
      [extrasBackdrop,wheelBackdrop,adventBackdrop,gameBackdrop,pinBackdrop,adminBackdrop,
       gamesHubBackdrop,presentBackdrop,memoryBackdrop,snowBackdrop,runnerBackdrop,treeBackdrop].forEach(closeBackdrop);
      beep(220,140,"square");
    }
  });

  // ===== Admin timeout =====
  let adminTimeout = 0;
  function adminArmTimeout(){
    clearTimeout(adminTimeout);
    adminTimeout = setTimeout(()=>closeBackdrop(adminBackdrop), 45_000);
  }
  adminBackdrop.addEventListener("mousemove", adminArmTimeout);
  adminBackdrop.addEventListener("touchstart", adminArmTimeout, {passive:true});
  adminBackdrop.addEventListener("keydown", adminArmTimeout);

  // ======================================================
  // =============== Jumping Elf ==========================
  // ======================================================
  const canvas = $("game");
  let ctx = null;

  async function resizeCanvas(){
    ctx = await fitCanvasSafe(canvas);
  }

  let raf = 0;
  let running = false;
  let score = 0;
  let level = 1;
  let lives = 3;
  let coinsRun = 0;

  const gameBoost = { life:0, slow:0 };

  const world = { ground: 0, gravity: 0.9, speed: 6.0 };
  const elf = { x: 90, y: 0, vy: 0, w: 46, h: 56, onGround: true, jumpCooldown: 0 };
  let obstacles = [];
  let coins = [];
  let t = 0;

  function setLivesUI(){
    $("lives").textContent = "‚ù§".repeat(lives) + "‚ô°".repeat(3-lives);
  }
  function setHud(){
    $("score").textContent = String(score);
    $("level").textContent = String(level);
    $("coins").textContent = String(coinsRun);
    $("dailyBest").textContent = String(getDailyBestAll());
  }
  function setStatus(html){ $("status").innerHTML = html; }

  function resetGame(){
    running = false;
    cancelAnimationFrame(raf); raf=0;
    score = 0;
    level = 1;
    coinsRun = 0;

    lives = 3;
    if(gameBoost.life){ lives = Math.min(3, lives + 1); gameBoost.life = 0; }

    world.speed = gameBoost.slow ? 5.2 : 6.0;
    world.gravity = 0.9;
    gameBoost.slow = 0;

    obstacles = [];
    coins = [];
    t = 0;

    elf.y = 0; elf.vy = 0; elf.onGround = true; elf.jumpCooldown = 0;

    setLivesUI();
    setHud();
    $("jumpBtn").disabled = true;
    setStatus('Tap <b>Start</b>, then tap the game (or <b>Jump</b>) to jump.');
    if(ctx) draw();
  }

  async function startGame(){
    ensureAudio();
    await resizeCanvas();
    running = true;
    $("jumpBtn").disabled = false;
    beep(660,70,"triangle");
    loop();
  }

  function endGame(reason){
    running = false;
    $("jumpBtn").disabled = true;

    // tally up run coins to global coins
    if(coinsRun > 0) addCoins(coinsRun, "Jumping Elf coins collected!");

    // unified daily best across all games
    setDailyBestAll(score);

    // small milestones
    if(score >= 10) addCoins(5, "Jumping Elf reward!");
    if(score >= 20) addSticker("Jumping Elf achievement!");

    refreshMini();
    setHud();
    beep(180,140,"square");
    setStatus(`${reason}<br/>Final score: <b>${score}</b> ‚Ä¢ Coins(run): <b>${coinsRun}</b><br/>Tap <b>Start</b> to play again.`);
  }

  function jump(){
    if(!running) return;
    if(elf.jumpCooldown > 0) return;
    if(elf.onGround){
      elf.vy = -15.8;
      elf.onGround = false;
      elf.jumpCooldown = 7;
      beep(760,55,"sine");
    }
  }

  function spawnObstacle(){
    const types = ["üéÅ","üç¨","‚õÑ"];
    const type = types[(Math.random()*types.length)|0];
    const w = type==="‚õÑ" ? 44 : 36;
    const h = type==="‚õÑ" ? 52 : 38;
    obstacles.push({ x: canvas.getBoundingClientRect().width + 40, w, h, type, scored:false });
  }

  function spawnCoin(){
    const baseY = 60 + (Math.random()*90);
    coins.push({ x: canvas.getBoundingClientRect().width + 30, y: baseY, r: 10, taken:false });
  }

  function rectsOverlap(ax,ay,aw,ah, bx,by,bw,bh){
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }

  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  // Cute elf "sprite" drawn with canvas shapes (no external images needed)
  function drawElf(x,y,scale=1){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale,scale);

    ctx.globalAlpha = 0.18;
    ctx.beginPath();
    ctx.ellipse(23, 54, 20, 6, 0, 0, Math.PI*2);
    ctx.fillStyle = "#000";
    ctx.fill();
    ctx.globalAlpha = 1;

    ctx.fillStyle = "#22b36d";
    roundRect(6, 22, 34, 28, 10); ctx.fill();

    ctx.fillStyle = "#111";
    roundRect(6, 36, 34, 8, 6); ctx.fill();
    ctx.strokeStyle = "#ffd972";
    ctx.lineWidth = 2;
    ctx.strokeRect(22, 37.5, 8, 5);

    ctx.fillStyle = "#ffd9b4";
    ctx.beginPath(); ctx.ellipse(23, 16, 15, 13, 0, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = "#178651";
    ctx.beginPath();
    ctx.moveTo(10,16); ctx.quadraticCurveTo(23,-2, 38,18); ctx.quadraticCurveTo(24,10,10,16);
    ctx.fill();
    ctx.fillStyle = "#f2f5f7";
    roundRect(8, 16, 30, 6, 4); ctx.fill();
    ctx.fillStyle = "#ffd972";
    ctx.beginPath(); ctx.arc(39,18,4,0,Math.PI*2); ctx.fill();

    ctx.fillStyle = "#1f2230";
    ctx.beginPath(); ctx.arc(18,16,2,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(28,16,2,0,Math.PI*2); ctx.fill();

    ctx.strokeStyle = "#b55652";
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(23,20,6,0.15*Math.PI,0.85*Math.PI); ctx.stroke();

    ctx.fillStyle = "#0b2b2b";
    drawRoundedRect(ctx, 8, 48, 14, 8, 4);
    ctx.fill();
    drawRoundedRect(ctx, 24, 48, 14, 8, 4);
    ctx.fill();

    ctx.restore();
  }

  function draw(){
    if(!ctx) return;
    const W = canvas.getBoundingClientRect().width;
    const H = canvas.getBoundingClientRect().height;
    world.ground = H - 56;

    ctx.clearRect(0,0,W,H);

    ctx.globalAlpha = 0.18;
    for(let i=0;i<24;i++){
      const sx = (i*43 + (t*0.8)%W) % W;
      const sy = 20 + (i*19)%120;
      ctx.fillStyle = "#fff";
      ctx.fillRect(sx, sy, 2, 2);
    }
    ctx.globalAlpha = 1;

    ctx.fillStyle = "rgba(255,255,255,.15)";
    ctx.fillRect(0, world.ground + 40, W, 2);

    ctx.fillStyle = "rgba(255,255,255,.10)";
    for(let i=0;i<12;i++){
      const bx = (i*80 - (t*2)%80);
      ctx.beginPath();
      ctx.ellipse(bx+40, world.ground+44, 40, 10, 0, 0, Math.PI*2);
      ctx.fill();
    }

    for(const c of coins){
      if(c.taken) continue;
      ctx.save();
      ctx.translate(c.x, c.y);
      ctx.fillStyle = "rgba(255,217,114,.95)";
      ctx.beginPath(); ctx.arc(0,0,c.r,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = "rgba(0,0,0,.18)";
      ctx.fillRect(-2,-6,4,12);
      ctx.restore();
    }

    for(const o of obstacles){
      ctx.fillStyle = "rgba(0,0,0,.18)";
      ctx.beginPath();
      ctx.ellipse(o.x + o.w/2, world.ground + 46, o.w/2, 6, 0, 0, Math.PI*2);
      ctx.fill();

      ctx.font = "36px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillText(o.type, o.x + o.w/2, world.ground + 44);
    }

    drawElf(elf.x, world.ground + 40 - elf.h - elf.y, 1);
  }

  function update(){
    const H = canvas.getBoundingClientRect().height;
    world.ground = H - 56;
    const speed = world.speed + Math.min(4, (level-1)*0.25);

    elf.jumpCooldown = Math.max(0, elf.jumpCooldown - 1);
    if(!elf.onGround){
      elf.vy += world.gravity;
      elf.y += elf.vy;
      if(elf.y <= 0){
        elf.y = 0; elf.vy = 0; elf.onGround = true;
      }
    }

    if(t % Math.max(48, 92 - level*4) === 0) spawnObstacle();
    if(t % 70 === 0) spawnCoin();

    for(const o of obstacles){ o.x -= speed; }
    obstacles = obstacles.filter(o => o.x > -80);

    for(const c of coins){ c.x -= (speed*0.9); }
    coins = coins.filter(c => c.x > -40 && !c.taken);

    for(const o of obstacles){
      if(!o.scored && (o.x + o.w) < elf.x){
        o.scored = true;
        score++;
        beep(980,45,"triangle");
        if(score % 5 === 0){
          level++;
          addSticker("Level up!");
          beep(660,45,"sine");
          setTimeout(()=>beep(880,55,"sine"), 80);
        }
      }
    }

    const elfRect = {
      x: elf.x+8,
      y: (world.ground + 40 - elf.h - elf.y)+8,
      w: elf.w-16,
      h: elf.h-10
    };
    for(const c of coins){
      if(c.taken) continue;
      const coinRect = { x: c.x - c.r, y: c.y - c.r, w: c.r*2, h: c.r*2 };
      if(rectsOverlap(elfRect.x, elfRect.y, elfRect.w, elfRect.h, coinRect.x, coinRect.y, coinRect.w, coinRect.h)){
        c.taken = true;
        coinsRun++;
        beep(1200,35,"sine");
      }
    }

    for(const o of obstacles){
      const oy = world.ground + 40 - o.h;
      const hit = rectsOverlap(
        elfRect.x, elfRect.y, elfRect.w, elfRect.h,
        o.x+6, oy+8, o.w-12, o.h-10
      );
      if(hit){
        lives--;
        setLivesUI();
        beep(160,120,"square");
        obstacles = obstacles.filter(x => x !== o);
        if(lives <= 0){
          endGame("Oh no! Jingles & Bells bumped into Christmas stuff üí•");
          return;
        }
      }
    }

    setHud();
  }

  function loop(){
    if(!running) return;
    t++;
    update();
    draw();
    raf = requestAnimationFrame(loop);
  }

  // ======================================================
  // =============== 5 EXTRA GAMES =========================
  // ======================================================

  const bestKey = (k)=>`elf_gamepack_best_${k}_v1`;
  const getBestX = (k)=>parseInt(get(bestKey(k),"0"),10)||0;
  const setBestX = (k,v)=>{ const cur=getBestX(k); if((v|0)>cur) set(bestKey(k), String(v|0)); };

  // ---------- Game 1: Present Catcher ----------
  const pcCanvas = $("pcCanvas");
  let pcCtx = null, pcRaf=0, pcRun=false;
  let pc = { score:0, miss:0, level:1, x:160, w:64, t:0, speed:2.2, drops:[] };

  function pcHud(){
    $("pcScore").textContent = String(pc.score);
    $("pcMiss").textContent = String(pc.miss);
    $("pcLevel").textContent = String(pc.level);
    $("pcBest").textContent = String(getBestX("present"));
  }
  function pcReset(){
    pc = { score:0, miss:0, level:1, x:160, w:76, t:0, speed:2.2, drops:[] };
    pcHud();
    $("pcStatus").textContent = "Drag left/right to move. Catch üéÅ, don‚Äôt miss 3!";
  }
  function pcStop(){ pcRun=false; cancelAnimationFrame(pcRaf); pcRaf=0; }
  async function pcStart(){
    pcReset();
    pcRun=true;
    pcCtx = await fitCanvasSafe(pcCanvas);
    pcLoop();
    beep(660,70,"triangle");
  }

  function pcSetX(clientX){
    const r = pcCanvas.getBoundingClientRect();
    const x = clientX - r.left;
    pc.x = Math.max(18, Math.min(r.width-18, x));
  }
  pcCanvas.addEventListener("mousemove", (e)=>{ if(pcRun) pcSetX(e.clientX); });
  pcCanvas.addEventListener("touchstart", (e)=>{
    if(!pcRun) return;
    e.preventDefault();
    pcSetX(e.touches[0].clientX);
  },{passive:false});
  pcCanvas.addEventListener("touchmove", (e)=>{
    if(!pcRun) return;
    e.preventDefault();
    pcSetX(e.touches[0].clientX);
  },{passive:false});

  function pcSpawn(){
    const r = pcCanvas.getBoundingClientRect();
    const x = 20 + Math.random()*(r.width-40);
    const kind = Math.random()<0.12 ? "‚≠ê" : "üéÅ";
    pc.drops.push({ x, y:-30, v: pc.speed + Math.random()*1.2, kind, dead:false });
  }
  function pcEnd(reason){
    pcStop();
    setBestX("present", pc.score);

    // Unified rewards
    setDailyBestAll(pc.score);
    if(pc.score >= 10) addCoins(5,"Present Catcher reward!");
    if(pc.score >= 20) addSticker("Present Catcher achievement!");
    refreshMini();

    pcHud();
    $("pcStatus").innerHTML = `${reason} Final score: <b>${pc.score}</b> (Best: ${getBestX("present")})`;
    beep(180,120,"square");
  }
  function pcDrawStatic(){
    if(!pcCtx) pcCtx = pcCanvas.getContext("2d");
    const r = pcCanvas.getBoundingClientRect();
    pcCtx.clearRect(0,0,r.width,r.height);
    pcCtx.fillStyle="rgba(255,255,255,.08)";
    pcCtx.fillRect(0,0,r.width,r.height);
    pcCtx.fillStyle="rgba(255,255,255,.9)";
    pcCtx.font="18px system-ui";
    pcCtx.fillText("Press Start", 18, 30);
    pcHud();
  }
  function pcLoop(){
    if(!pcRun) return;
    const r = pcCanvas.getBoundingClientRect();
    pc.t++;

    pc.level = 1 + Math.floor(pc.score/10);
    pc.speed = 2.2 + pc.level*0.35;

    if(pc.t % Math.max(18, 42 - pc.level*2) === 0) pcSpawn();

    for(const d of pc.drops){ d.y += d.v; }

    const basketY = r.height - 70;
    const basketX = pc.x - pc.w/2;

    for(const d of pc.drops){
      if(d.dead) continue;
      const hit = d.y > basketY-18 && d.y < basketY+30 && d.x > basketX && d.x < basketX+pc.w;
      if(hit){
        d.dead = true;
        if(d.kind==="‚≠ê"){ pc.score += 3; beep(1000,55,"sine"); }
        else { pc.score += 1; beep(860,40,"triangle"); }
      } else if(d.y > r.height + 40){
        d.dead = true;
        pc.miss += 1;
        beep(220,80,"square");
        if(pc.miss>=3) return pcEnd("Oh no ‚Äî too many missed presents!");
      }
    }
    pc.drops = pc.drops.filter(d=>!d.dead);

    const c = pcCtx;
    c.clearRect(0,0,r.width,r.height);
    c.fillStyle="rgba(0,0,0,.18)";
    c.fillRect(0,0,r.width,r.height);

    c.fillStyle="rgba(255,255,255,.08)";
    for(let i=0;i<18;i++){
      c.fillRect((i*73 + pc.t*1.2)%r.width, (i*33)%r.height, 2, 2);
    }

    c.font="30px system-ui";
    c.textAlign="center";
    c.textBaseline="middle";
    for(const d of pc.drops) c.fillText(d.kind, d.x, d.y);

    c.fillStyle="rgba(255,255,255,.18)";
    drawRoundedRect(c, basketX, basketY, pc.w, 18, 10);
    c.fill();

    c.font="40px system-ui";
    c.fillText("üßù", pc.x, basketY-20);

    pcHud();
    pcRaf = requestAnimationFrame(pcLoop);
  }

  // ---------- Game 2: Memory Match ----------
  const mmGrid = $("mmGrid");
  let mmTimer=0, mmSecs=0, mmMoves=0, mmMatches=0;
  let mmOpen = [];
  let mmLock=false;
  let mmHard=false;

  const MM_EMOJI = ["üéÑ","üéÅ","‚ùÑÔ∏è","üç¨","‚≠ê","ü¶å","üß∏","üéÖ","‚ú®","üîî","üßù","üïØÔ∏è"];

  function mmStopTimer(){ clearInterval(mmTimer); mmTimer=0; }
  function mmStartTimer(){
    mmStopTimer();
    mmSecs=0;
    $("mmTime").textContent="0";
    mmTimer=setInterval(()=>{
      mmSecs++;
      $("mmTime").textContent=String(mmSecs);
    },1000);
  }

  function mmBestLabel(){
    const key = mmHard ? "memory_hard" : "memory";
    const best = get(bestKey(key), "");
    $("mmBest").textContent = best || "--";
  }

  function mmNewGame(){
    mmStopTimer();
    mmStartTimer();
    mmGrid.innerHTML="";
    mmMoves=0; mmMatches=0; mmOpen=[]; mmLock=false;

    const pairs = mmHard ? 10 : 8;
    $("mmTotal").textContent = String(pairs);
    $("mmMoves").textContent="0";
    $("mmMatches").textContent="0";
    $("mmStatus").textContent = "Find all the pairs!";

    const pool = [...MM_EMOJI].sort(()=>Math.random()-0.5).slice(0, pairs);
    const cards = [...pool, ...pool].sort(()=>Math.random()-0.5);

    mmGrid.style.gridTemplateColumns = `repeat(${mmHard ? 5 : 4}, 1fr)`;

    cards.forEach((emo)=>{
      const card = document.createElement("div");
      card.className="mmCard";
      card.dataset.emo = emo;
      card.innerHTML = `<div class="mmBack">üé¥</div><div class="mmFace">${emo}</div>`;
      card.addEventListener("click", ()=>mmFlip(card));
      mmGrid.appendChild(card);
    });

    mmBestLabel();
  }

  function compareMM(a,b){
    const pa = a.match(/(\d+)\s+moves.*?(\d+)s/);
    const pb = b.match(/(\d+)\s+moves.*?(\d+)s/);
    if(!pa || !pb) return 0;
    const am = +pa[1], as = +pa[2];
    const bm = +pb[1], bs = +pb[2];
    if(am !== bm) return am - bm;
    return as - bs;
  }

  function mmFinish(){
    mmStopTimer();
    const label = `${mmMoves} moves ‚Ä¢ ${mmSecs}s`;
    const key = mmHard ? "memory_hard" : "memory";
    const prev = get(bestKey(key), "");
    const improved = !prev || compareMM(label, prev) < 0;
    if(improved) set(bestKey(key), label);
    mmBestLabel();

    // Unified rewards
    const coinReward = mmHard ? 10 : 6;
    addCoins(coinReward, "Memory Match reward!");
    addSticker("Memory Match completed!");
    // Convert to a score-like number for daily best competition
    const scoreLike = Math.max(0, 1000 - (mmMoves*10 + mmSecs));
    setDailyBestAll(scoreLike);
    refreshMini();

    $("mmStatus").innerHTML = `Done! <b>${label}</b> üéâ`;
    beep(920,60,"sine");
    setTimeout(()=>beep(1120,70,"triangle"),100);
  }

  function mmFlip(card){
    if(mmLock) return;
    if(card.classList.contains("matched")) return;
    if(card.classList.contains("revealed")) return;

    card.classList.add("revealed");
    beep(740,35,"triangle");

    mmOpen.push(card);
    if(mmOpen.length === 2){
      mmMoves++;
      $("mmMoves").textContent=String(mmMoves);
      const [a,b] = mmOpen;
      const same = a.dataset.emo === b.dataset.emo;
      mmLock = true;
      setTimeout(()=>{
        if(same){
          a.classList.add("matched");
          b.classList.add("matched");
          mmMatches++;
          $("mmMatches").textContent=String(mmMatches);
          beep(980,55,"sine");
          if(mmMatches === parseInt($("mmTotal").textContent,10)) mmFinish();
        }else{
          a.classList.remove("revealed");
          b.classList.remove("revealed");
          beep(220,70,"square");
        }
        mmOpen = [];
        mmLock = false;
      }, same ? 260 : 520);
    }
  }

  // ---------- Game 3: Snowball Pop ----------
  const spCanvas = $("spCanvas");
  let spCtx=null, spRaf=0, spRun=false;
  let sp = { score:0, miss:0, level:1, t:0, balls:[] };

  function spHud(){
    $("spScore").textContent=String(sp.score);
    $("spMiss").textContent=String(sp.miss);
    $("spLevel").textContent=String(sp.level);
    $("spBest").textContent=String(getBestX("snow"));
  }
  function spReset(){
    sp = { score:0, miss:0, level:1, t:0, balls:[] };
    spHud();
    $("spStatus").textContent="Tap snowballs to pop them. Avoid the green ‚ÄúGrinch‚Äù one!";
  }
  function spStop(){ spRun=false; cancelAnimationFrame(spRaf); spRaf=0; }
  async function spStart(){
    spReset();
    spRun=true;
    spCtx = await fitCanvasSafe(spCanvas);
    spLoop();
    beep(660,70,"triangle");
  }

  function spSpawn(){
    const r = spCanvas.getBoundingClientRect();
    const grinch = Math.random() < 0.12;
    const rad = grinch ? 18 : (12 + Math.random()*10);
    sp.balls.push({
      x: 30 + Math.random()*(r.width-60),
      y: r.height + 30,
      r: rad,
      vy: 1.2 + Math.random()*1.3 + sp.level*0.18,
      kind: grinch ? "grinch" : "snow",
      alive:true
    });
  }

  spCanvas.addEventListener("click",(e)=>{
    if(!spRun) return;
    const r = spCanvas.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    for(const b of sp.balls){
      if(!b.alive) continue;
      const dx=x-b.x, dy=y-b.y;
      if(dx*dx + dy*dy <= b.r*b.r){
        b.alive=false;
        if(b.kind==="grinch"){
          sp.score = Math.max(0, sp.score - 3);
          beep(180,90,"square");
        } else {
          sp.score += (b.r >= 18 ? 2 : 1);
          beep(1000,35,"sine");
        }
        break;
      }
    }
  });
  spCanvas.addEventListener("touchstart",(e)=>{
    if(!spRun) return;
    e.preventDefault();
    const t0 = e.touches[0];
    const r = spCanvas.getBoundingClientRect();
    const x = t0.clientX - r.left;
    const y = t0.clientY - r.top;
    for(const b of sp.balls){
      if(!b.alive) continue;
      const dx=x-b.x, dy=y-b.y;
      if(dx*dx + dy*dy <= b.r*b.r){
        b.alive=false;
        if(b.kind==="grinch"){
          sp.score = Math.max(0, sp.score - 3);
          beep(180,90,"square");
        } else {
          sp.score += (b.r >= 18 ? 2 : 1);
          beep(1000,35,"sine");
        }
        break;
      }
    }
  },{passive:false});

  function spEnd(reason){
    spStop();
    setBestX("snow", sp.score);

    // Unified rewards
    setDailyBestAll(sp.score);
    if(sp.score >= 12) addCoins(5,"Snowball Pop reward!");
    if(sp.score >= 25) addSticker("Snowball Pop achievement!");
    refreshMini();

    spHud();
    $("spStatus").innerHTML = `${reason} Final score: <b>${sp.score}</b> (Best: ${getBestX("snow")})`;
    beep(180,120,"square");
  }

  function spLoop(){
    if(!spRun) return;
    const r = spCanvas.getBoundingClientRect();
    sp.t++;
    sp.level = 1 + Math.floor(sp.score/12);

    if(sp.t % Math.max(10, 26 - sp.level) === 0) spSpawn();

    for(const b of sp.balls){
      if(!b.alive) continue;
      b.y -= b.vy;
      if(b.y < -40){
        b.alive=false;
        sp.miss++;
        beep(220,60,"square");
        if(sp.miss >= 5) return spEnd("Too many missed snowballs!");
      }
    }
    sp.balls = sp.balls.filter(b=>b.alive);

    const c=spCtx;
    c.clearRect(0,0,r.width,r.height);
    c.fillStyle="rgba(0,0,0,.18)";
    c.fillRect(0,0,r.width,r.height);

    for(const b of sp.balls){
      c.beginPath();
      c.arc(b.x,b.y,b.r,0,Math.PI*2);
      c.fillStyle = b.kind==="grinch" ? "rgba(80,220,120,.9)" : "rgba(255,255,255,.92)";
      c.fill();
      c.strokeStyle="rgba(0,0,0,.15)";
      c.stroke();

      if(b.kind==="grinch"){
        c.fillStyle="rgba(0,0,0,.55)";
        c.font="12px system-ui";
        c.textAlign="center";
        c.fillText("GR", b.x, b.y+4);
      }
    }

    spHud();
    spRaf=requestAnimationFrame(spLoop);
  }

  // ---------- Game 4: Candy Cane Runner ----------
  const crCanvas = $("crCanvas");
  let crCtx=null, crRaf=0, crRun=false;
  let cr = { score:0, level:1, lane:0, t:0, obs:[] };

  function crHud(){
    $("crScore").textContent=String(cr.score);
    $("crLevel").textContent=String(cr.level);
    $("crBest").textContent=String(getBestX("runner"));
  }
  function crReset(){
    cr = { score:0, level:1, lane:0, t:0, obs:[] };
    crHud();
    $("crSwitch").disabled = true;
    $("crStatus").textContent="Tap Switch (or tap the game) to change lanes and avoid obstacles.";
  }
  function crStop(){ crRun=false; cancelAnimationFrame(crRaf); crRaf=0; }
  async function crStart(){
    crReset();
    crRun=true;
    crCtx = await fitCanvasSafe(crCanvas);
    $("crSwitch").disabled = false;
    crLoop();
    beep(660,70,"triangle");
  }

  function crSwitch(){
    if(!crRun) return;
    cr.lane = cr.lane ? 0 : 1;
    beep(860,40,"triangle");
  }

  function crSpawn(){
    const r = crCanvas.getBoundingClientRect();
    const lane = Math.random()<0.5 ? 0 : 1;
    cr.obs.push({ x: r.width + 40, lane, hit:false });
  }

  function crEnd(reason){
    crStop();
    $("crSwitch").disabled = true;
    setBestX("runner", cr.score);

    // Unified rewards
    setDailyBestAll(cr.score);
    if(cr.score >= 15) addCoins(5,"Candy Cane Runner reward!");
    if(cr.score >= 35) addSticker("Candy Cane Runner achievement!");
    refreshMini();

    crHud();
    $("crStatus").innerHTML = `${reason} Final score: <b>${cr.score}</b> (Best: ${getBestX("runner")})`;
    beep(180,120,"square");
  }

  function crLoop(){
    if(!crRun) return;
    const r = crCanvas.getBoundingClientRect();
    cr.t++;
    cr.level = 1 + Math.floor(cr.score/10);
    const speed = 5.2 + cr.level*0.3;

    if(cr.t % Math.max(22, 52 - cr.level*3) === 0) crSpawn();
    for(const o of cr.obs) o.x -= speed;
    cr.obs = cr.obs.filter(o=>o.x > -80 && !o.hit);

    if(cr.t % 18 === 0){
      cr.score++;
      if(cr.score % 5 === 0) beep(980,25,"sine");
    }

    const elfX = 120;
    const laneYTop = 120;
    const laneYBot = r.height - 120;
    const elfY = cr.lane ? laneYTop : laneYBot;

    for(const o of cr.obs){
      const oy = o.lane ? laneYTop : laneYBot;
      const dx = Math.abs((o.x) - elfX);
      const dy = Math.abs((oy) - elfY);
      if(dx < 26 && dy < 26){
        o.hit=true;
        return crEnd("Crash! Jingles & Bells hit an obstacle üí•");
      }
    }

    const c=crCtx;
    c.clearRect(0,0,r.width,r.height);
    c.fillStyle="rgba(0,0,0,.18)";
    c.fillRect(0,0,r.width,r.height);

    c.strokeStyle="rgba(255,255,255,.15)";
    c.lineWidth=2;
    c.beginPath(); c.moveTo(0,laneYTop); c.lineTo(r.width,laneYTop); c.stroke();
    c.beginPath(); c.moveTo(0,laneYBot); c.lineTo(r.width,laneYBot); c.stroke();

    c.font="42px system-ui";
    c.textAlign="center";
    c.textBaseline="middle";
    c.fillText("üßù", elfX, elfY);

    for(const o of cr.obs){
      const oy = o.lane ? laneYTop : laneYBot;
      c.fillText("üç≠", o.x, oy);
    }

    crHud();
    crRaf=requestAnimationFrame(crLoop);
  }

  // ---------- Game 5: Decorate the Tree ----------
  const dtTree = $("dtTree");
  const dtTray = $("dtOrnaments");
  let dtTimer=0, dtTime=30, dtPlaced=0, dtRunning=false;
  let dtSelected = "üî¥";

  function dtHud(){
    $("dtPlaced").textContent=String(dtPlaced);
    $("dtTime").textContent=String(dtTime);
    $("dtBest").textContent=String(getBestX("tree"));
  }
  function dtStop(){ dtRunning=false; clearInterval(dtTimer); dtTimer=0; }

  function dtPlace(emo, x, y){
    const placed = document.createElement("div");
    placed.className="dtPlaced";
    placed.textContent=emo;
    placed.style.left = x + "px";
    placed.style.top = y + "px";
    dtTree.appendChild(placed);
    dtPlaced++;
    dtHud();
    beep(1000,35,"sine");
  }

  function dtResetBoard(){
    dtStop();
    dtTime=30; dtPlaced=0;
    dtTree.querySelectorAll(".dtPlaced").forEach(n=>n.remove());
    dtTray.innerHTML="";
    const ornaments = ["üî¥","üîµ","üü°","üü£","üü¢","üßÅ","üç¨","‚ú®","üîî","üç≠","ü™Ä","üß∏"];
    ornaments.forEach((emo)=>{
      const o = document.createElement("div");
      o.className="dtOrn";
      o.textContent=emo;
      o.draggable = true;
      o.dataset.emo = emo;

      o.addEventListener("dragstart", (e)=>{
        try{ e.dataTransfer.setData("text/plain", emo); }catch{}
        beep(740,30,"triangle");
      });

      o.addEventListener("click", ()=>{
        if(!dtRunning) return;
        const r = dtTree.getBoundingClientRect();
        dtPlace(emo, r.width*0.5 + (Math.random()*180-90), r.height*0.58 + (Math.random()*180-90));
      });

      dtTray.appendChild(o);
    });

    dtSelected = "üî¥";
    dtHud();
    $("dtStatus").textContent="Press Start, then drag ornaments onto the tree (or tap an ornament).";
  }

  dtTree.addEventListener("dragover", (e)=>{ e.preventDefault(); });
  dtTree.addEventListener("drop", (e)=>{
    e.preventDefault();
    if(!dtRunning) return;
    const emo = (e.dataTransfer && e.dataTransfer.getData) ? e.dataTransfer.getData("text/plain") : "";
    const r = dtTree.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    if(emo) dtPlace(emo, x, y);
  });

  dtTray.addEventListener("click", (e)=>{
    const t0 = e.target;
    if(t0 && t0.classList && t0.classList.contains("dtOrn")){
      dtSelected = t0.textContent;
      beep(740,30,"triangle");
    }
  });

  dtTree.addEventListener("click", (e)=>{
    if(!dtRunning) return;
    const r = dtTree.getBoundingClientRect();
    dtPlace(dtSelected, e.clientX - r.left, e.clientY - r.top);
  });

  dtTree.addEventListener("touchstart", (e)=>{
    if(!dtRunning) return;
    e.preventDefault();
    const t0 = e.touches[0];
    const r = dtTree.getBoundingClientRect();
    dtPlace(dtSelected, t0.clientX - r.left, t0.clientY - r.top);
  }, {passive:false});

  function dtStart(){
    dtResetBoard();
    dtRunning=true;
    dtTime=30;
    dtHud();
    $("dtStatus").textContent="Go go go! Jingles & Bells want a super pretty tree!";
    dtTimer=setInterval(()=>{
      dtTime--;
      dtHud();
      if(dtTime<=0){
        dtStop();
        setBestX("tree", dtPlaced);

        // Unified rewards
        setDailyBestAll(dtPlaced);
        if(dtPlaced >= 8) addCoins(5,"Tree decorating reward!");
        if(dtPlaced >= 14) addSticker("Tree decorating achievement!");
        refreshMini();

        dtHud();
        $("dtStatus").innerHTML = `Time! You placed <b>${dtPlaced}</b>. Best: <b>${getBestX("tree")}</b>`;
        beep(180,120,"square");
      }
    },1000);
    beep(660,70,"triangle");
  }

  function closeStopper(backdropEl, stopFn){
    backdropEl.addEventListener("click", (e)=>{
      if(e.target === backdropEl){
        try{ stopFn(); }catch{}
        closeBackdrop(backdropEl);
      }
    });
  }
  closeStopper(presentBackdrop, pcStop);
  closeStopper(memoryBackdrop, mmStopTimer);
  closeStopper(snowBackdrop, spStop);
  closeStopper(runnerBackdrop, crStop);
  closeStopper(treeBackdrop, dtStop);

  // ===== UI Wiring =====
  function initUI(){
    $("dateLabel").textContent = new Date().toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });

    $("openGamesHubFront").addEventListener("click", ()=>{
      openBackdrop(gamesHubBackdrop);
      beep(740,45,"triangle");
    });

    $("openExtras").addEventListener("click", ()=>{ openBackdrop(extrasBackdrop); });
    $("closeExtras").addEventListener("click", ()=>closeBackdrop(extrasBackdrop));

    $("openWheel").addEventListener("click", ()=>{
      renderWheelStatus();
      $("wheelResult").textContent = "Tap ‚ÄúSpin‚Äù!";
      $("wheelNote").textContent = "You can spin once per day.";
      openBackdrop(wheelBackdrop);
    });
    $("closeWheel").addEventListener("click", ()=>closeBackdrop(wheelBackdrop));

    $("spinBtn").addEventListener("click", ()=>{
      if(wheelDone()){ beep(180,120,"square"); return; }
      setWheelDone(true);
      renderWheelStatus();

      const idx = (Math.random()*WHEEL.length)|0;
      const extra = 360*4 + idx*(360/WHEEL.length) + (Math.random()*18-9);
      wheelRot += extra;
      $("wheel").style.setProperty("--wheelRot", wheelRot + "deg");

      beep(440,60,"sine");
      setTimeout(()=>beep(660,60,"sine"),150);
      setTimeout(()=>{
        const prize = WHEEL[idx];
        $("wheelResult").textContent = prize.label;
        try{ prize.apply(); }catch{}
      }, 3300);
    });

    $("openAdvent").addEventListener("click", ()=>{
      renderAdventGrid();
      openBackdrop(adventBackdrop);
    });
    $("closeAdvent").addEventListener("click", ()=>closeBackdrop(adventBackdrop));

    $("addHeart").addEventListener("click", ()=>{
      const h = readHearts();
      h.count = (h.count|0) + 1;
      writeHearts(h);
      renderHearts();
      beep(920,55,"triangle");
    });
    $("resetHearts").addEventListener("click", ()=>{
      writeHearts({day:todayKey(), count:0});
      renderHearts();
      beep(220,120,"square");
    });

    $("challengeDone").addEventListener("click", ()=>{
      const c = readChallenge();
      if(!c.done){
        c.done = true;
        writeChallenge(c);
        addSticker("Challenge completed!");
        addCoins(5,"Challenge reward!");
      }
      renderChallenge();
    });
    $("challengeNew").addEventListener("click", ()=>{
      const c = readChallenge();
      c.text = CHALLENGES[(Math.random()*CHALLENGES.length)|0];
      c.done = false;
      writeChallenge(c);
      renderChallenge();
      beep(660,60,"sine");
    });

    $("jokeBtn").addEventListener("click", ()=>{
      $("funOutput").textContent = JOKES[(Math.random()*JOKES.length)|0];
      beep(740,55,"triangle");
    });
    $("riddleBtn").addEventListener("click", ()=>{
      const r = RIDDLES[(Math.random()*RIDDLES.length)|0];
      $("funOutput").textContent = r.q + "  (Tap again for answer)";
      let once = true;
      const handler = ()=>{
        if(!once) return;
        once = false;
        $("funOutput").textContent = "Answer: " + r.a;
        beep(920,55,"sine");
        $("riddleBtn").removeEventListener("click", handler);
      };
      $("riddleBtn").addEventListener("click", handler);
      beep(520,55,"triangle");
    });
    $("surpriseBtn").addEventListener("click", ()=>{
      $("funOutput").textContent = SURPRISES[(Math.random()*SURPRISES.length)|0];
      beep(860,55,"sine");
    });

    $("handBtn").addEventListener("click", ()=>{
      const on = get(KEYS.hand,"0")==="1";
      set(KEYS.hand, on ? "0":"1");
      applyPrefs();
      beep(760,45,"sine");
    });
    $("stampBtn").addEventListener("click", ()=>{
      const on = get(KEYS.stamp,"1")!=="0";
      set(KEYS.stamp, on ? "0":"1");
      applyPrefs();
      beep(760,45,"sine");
    });
    $("twinkleBtn").addEventListener("click", ()=>{
      const on = get(KEYS.twinkle,"1")!=="0";
      set(KEYS.twinkle, on ? "0":"1");
      applyPrefs();
      beep(760,45,"sine");
    });
    $("snowBtn").addEventListener("click", ()=>{
      const on = get(KEYS.snowOn,"1")!=="0";
      set(KEYS.snowOn, on ? "0":"1");
      applyPrefs();
      beep(760,45,"sine");
    });
    $("snowRange").addEventListener("input", (e)=>{
      set(KEYS.snowPct, String(e.target.value|0));
      applyPrefs();
    });

    $("bigTextBtn").addEventListener("click", ()=>{
      const on = get(KEYS.bigText,"0")==="1";
      set(KEYS.bigText, on ? "0":"1");
      applyPrefs();
      beep(760,45,"sine");
    });
    $("accessBtn").addEventListener("click", ()=>{
      const on = get(KEYS.access,"0")==="1";
      set(KEYS.access, on ? "0":"1");
      applyPrefs();
      beep(760,45,"sine");
    });
    $("perfBtn").addEventListener("click", ()=>{
      const on = get(KEYS.perf,"0")==="1";
      set(KEYS.perf, on ? "0":"1");
      applyPrefs();
      beep(760,45,"sine");
    });

    $("soundToggle").addEventListener("click", ()=>{
      soundOn = !soundOn;
      syncSoundButton();
      beep(880,60,"sine");
    });

    // Jumping Elf popup
    $("closeGame").addEventListener("click", ()=>{
      closeBackdrop(gameBackdrop);
      resetGame();
    });

    $("zoomBtn").addEventListener("click", ()=>{
      document.body.classList.toggle("zoomed");
      setTimeout(async ()=>{
        await resizeCanvas();
        draw();
      }, 80);
    });

    $("startBtn").addEventListener("click", ()=>{
      if(running){ resetGame(); return; }
      resetGame();
      startGame();
    });

    $("jumpBtn").addEventListener("click", jump);
    canvas.addEventListener("click", jump);
    canvas.addEventListener("touchstart", (e)=>{ e.preventDefault(); jump(); }, {passive:false});

    // Games Hub
    $("closeGamesHub").addEventListener("click", ()=>closeBackdrop(gamesHubBackdrop));

    $("openJumpingElfFromHub").addEventListener("click", ()=>{
      closeBackdrop(gamesHubBackdrop);
      openBackdrop(gameBackdrop);
      afterOpen(gameBackdrop, async ()=>{
        await resizeCanvas();
        draw();
      });
      beep(740,45,"triangle");
    });

    // Open other games
    $("openGame1").addEventListener("click", ()=>{
      closeBackdrop(gamesHubBackdrop);
      openBackdrop(presentBackdrop);
      afterOpen(presentBackdrop, async ()=>{ pcCtx = await fitCanvasSafe(pcCanvas); pcDrawStatic(); });
    });

    $("openGame2").addEventListener("click", ()=>{
      closeBackdrop(gamesHubBackdrop);
      openBackdrop(memoryBackdrop);
      afterOpen(memoryBackdrop, ()=>{ mmNewGame(); });
    });

    $("openGame3").addEventListener("click", ()=>{
      closeBackdrop(gamesHubBackdrop);
      openBackdrop(snowBackdrop);
      afterOpen(snowBackdrop, async ()=>{ spCtx = await fitCanvasSafe(spCanvas); });
    });

    $("openGame4").addEventListener("click", ()=>{
      closeBackdrop(gamesHubBackdrop);
      openBackdrop(runnerBackdrop);
      afterOpen(runnerBackdrop, async ()=>{ crCtx = await fitCanvasSafe(crCanvas); });
    });

    $("openGame5").addEventListener("click", ()=>{
      closeBackdrop(gamesHubBackdrop);
      openBackdrop(treeBackdrop);
      afterOpen(treeBackdrop, ()=>{ dtResetBoard(); });
    });

    // Game buttons inside modals
    $("pcStart").addEventListener("click", ()=>{ if(!pcRun) pcStart(); });
    $("spStart").addEventListener("click", ()=>{ if(!spRun) spStart(); });
    $("crStart").addEventListener("click", ()=>{ if(!crRun) crStart(); });
    $("crSwitch").addEventListener("click", ()=>crSwitch());
    crCanvas.addEventListener("click", ()=>crSwitch());
    crCanvas.addEventListener("touchstart", (e)=>{ e.preventDefault(); crSwitch(); }, {passive:false });
    $("dtStart").addEventListener("click", ()=>{ if(!dtRunning) dtStart(); });
    $("dtReset").addEventListener("click", dtResetBoard);

    $("mmNew").addEventListener("click", mmNewGame);
    $("mmHard").addEventListener("click", ()=>{
      mmHard = !mmHard;
      $("mmHard").textContent = "Difficulty: " + (mmHard ? "Hard" : "Normal");
      mmNewGame();
    });

    // Close buttons for other games
    $("closePresent").addEventListener("click", ()=>{ pcStop(); closeBackdrop(presentBackdrop); });
    $("closeMemory").addEventListener("click", ()=>{ mmStopTimer(); closeBackdrop(memoryBackdrop); });
    $("closeSnow").addEventListener("click", ()=>{ spStop(); closeBackdrop(snowBackdrop); });
    $("closeRunner").addEventListener("click", ()=>{ crStop(); closeBackdrop(runnerBackdrop); });
    $("closeTree").addEventListener("click", ()=>{ dtStop(); closeBackdrop(treeBackdrop); });

    // PIN / admin
    $("pinClose").addEventListener("click", ()=>closeBackdrop(pinBackdrop));
    $("pinOk").addEventListener("click", ()=>{
      const entered = ($("pinInput").value || "").trim();
      const good = get(KEYS.pin,"1234");
      if(entered === good){
        closeBackdrop(pinBackdrop);
        showAdmin();
        beep(920,60,"sine");
      } else {
        $("pinErr").textContent = "Wrong PIN.";
        beep(180,120,"square");
      }
    });

    $("adminClose").addEventListener("click", ()=>closeBackdrop(adminBackdrop));

    $("saveToday").addEventListener("click", ()=>{
      set(KEYS.msgDefault, $("adminMsg").value || "");
      renderMessage();
      beep(920,60,"sine");
    });

    $("saveScheduled").addEventListener("click", ()=>{
      const d = ($("schedDate").value || "").trim();
      const txt = ($("schedText").value || "").trim();
      if(!/^\d{4}-\d{2}-\d{2}$/.test(d) || !txt){
        beep(180,120,"square");
        return;
      }
      const map = readMap(KEYS.msgByDate);
      map[d] = txt;
      writeMap(KEYS.msgByDate, map);
      renderMessage();
      beep(920,60,"sine");
    });

    $("clearScheduled").addEventListener("click", ()=>{
      const d = ($("schedDate").value || "").trim();
      const map = readMap(KEYS.msgByDate);
      delete map[d];
      writeMap(KEYS.msgByDate, map);
      renderMessage();
      beep(220,120,"square");
    });

    $("setPin").addEventListener("click", ()=>{
      const p = ($("newPin").value || "").trim();
      if(!/^\d{4,8}$/.test(p)){
        beep(180,120,"square");
        return;
      }
      set(KEYS.pin, p);
      $("newPin").value = "";
      beep(920,60,"sine");
    });

    $("exportBtn").addEventListener("click", ()=>{
      const payload = {
        v:4,
        pin:get(KEYS.pin,"1234"),
        msgDefault:get(KEYS.msgDefault,""),
        msgByDate:readMap(KEYS.msgByDate),
        prefs:{
          hand:get(KEYS.hand,"0"),
          stamp:get(KEYS.stamp,"1"),
          twinkle:get(KEYS.twinkle,"1"),
          snowOn:get(KEYS.snowOn,"1"),
          snowPct:get(KEYS.snowPct,"55"),
          bigText:get(KEYS.bigText,"0"),
          access:get(KEYS.access,"0"),
          perf:get(KEYS.perf,"0"),
          sound:get(KEYS.sound,"1")
        },
        coins:get(KEYS.coins,"0"),
        dailyBestAll:readNumMap(KEYS.dailyBestAll),
      };
      $("backupBox").value = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
      beep(920,60,"sine");
    });

    $("importBtn").addEventListener("click", ()=>{
      const raw = ($("backupBox").value || "").trim();
      if(!raw){ beep(180,120,"square"); return; }
      try{
        const obj = JSON.parse(decodeURIComponent(escape(atob(raw))));
        if(!obj || obj.v !== 4) throw new Error("Bad backup");
        set(KEYS.pin, String(obj.pin||"1234"));
        set(KEYS.msgDefault, String(obj.msgDefault||""));
        writeMap(KEYS.msgByDate, obj.msgByDate || {});
        const p = obj.prefs || {};
        set(KEYS.hand, p.hand ?? "0");
        set(KEYS.stamp, p.stamp ?? "1");
        set(KEYS.twinkle, p.twinkle ?? "1");
        set(KEYS.snowOn, p.snowOn ?? "1");
        set(KEYS.snowPct, p.snowPct ?? "55");
        set(KEYS.bigText, p.bigText ?? "0");
        set(KEYS.access, p.access ?? "0");
        set(KEYS.perf, p.perf ?? "0");
        set(KEYS.sound, p.sound ?? "1");
        set(KEYS.coins, String(obj.coins||"0"));
        set(KEYS.dailyBestAll, JSON.stringify(obj.dailyBestAll||{}));
        soundOn = get(KEYS.sound,"1") !== "0";
        applyPrefs();
        renderMessage();
        refreshMini();
        renderStickers();
        renderChallenge();
        renderHearts();
        renderMood();
        beep(920,60,"sine");
      }catch{
        beep(180,120,"square");
      }
    });

    $("resetDayBtn").addEventListener("click", ()=>{
      set(KEYS.dayKey, "");
      ensureDaily();
      renderStickers();
      renderChallenge();
      renderHearts();
      renderWheelStatus();
      refreshMini();
      beep(220,120,"square");
    });

    $("factoryBtn").addEventListener("click", ()=>{
      if(storageOK){
        Object.values(KEYS).forEach(k=>localStorage.removeItem(k));
      }
      // restore defaults
      set(KEYS.pin,"1234");
      set(KEYS.hand,"0"); set(KEYS.stamp,"1"); set(KEYS.twinkle,"1"); set(KEYS.snowOn,"1");
      set(KEYS.snowPct,"55"); set(KEYS.bigText,"0"); set(KEYS.access,"0"); set(KEYS.perf,"0");
      set(KEYS.sound,"1"); soundOn = true;
      set(KEYS.coins,"0");
      set(KEYS.dailyBestAll,"{}");
      set(KEYS.advent,'{"open":[]}');
      set(KEYS.mood,"");
      set(KEYS.dayKey,"");
      ensureDaily();
      applyPrefs();
      renderMessage();
      refreshMini();
      renderStickers();
      renderChallenge();
      renderHearts();
      renderMood();
      beep(220,140,"square");
    });
  }

  // ===== FINAL INIT =====
  ensureDaily();
  renderMessage();
  renderMood();
  renderStickers();
  renderChallenge();
  renderHearts();
  refreshMini();
  applyPrefs();
  initUI();

  // initial states
  resetGame();
  dtResetBoard();
  mmNewGame();
  setTimeout(()=>{ renderWheelStatus(); }, 50);

  tickCountdown();
  setInterval(tickCountdown, 1000);

})();
</script>
</body>
</html>
