<!doctype html>
<html lang="utf-8">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Jingles & Bells ‚Äî Daily Elf Message</title>
<style>
  :root{
    --bg1:#2a4a78; --bg2:#061024; --bg3:#02030a;
    --panel1:#1f3858; --panel2:#060b16;
    --msg1:#2b5175; --msg2:#071022;

    --white:#fff;
    --gold:#ffd972;
    --shadow: rgba(0,0,0,.55);
    --frame-red:#e04545;
    --frame-green:#209862;

    --btn-bg: rgba(255,255,255,.08);
    --btn-border: rgba(255,255,255,.18);

    --plain: system-ui,-apple-system,"Segoe UI",sans-serif;
    --hand: ui-rounded,"Bradley Hand","Comic Sans MS","Segoe Print",system-ui,sans-serif;

    --moodAccent: rgba(255,217,114,.25);
  }

  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{
    margin:0; min-height:100vh; font-family:var(--plain); color:var(--white);
    background: radial-gradient(circle at top, var(--bg1) 0, var(--bg2) 55%, var(--bg3) 100%);
    display:flex; justify-content:center; align-items:center;
    padding:14px;
    overflow-y:auto;        /* ‚úÖ allow scrolling on smaller screens */
    overflow-x:hidden;
    -webkit-user-select:none; user-select:none;
  }
  body.bigtext .msg{ font-size: clamp(1.45rem, 2.6vw + 1rem, 2.35rem); }
  body.bigtext .btnBig{ font-size:1.15rem; padding:16px 18px; }
  body.bigtext .chip, body.bigtext .btnG { font-size:.95rem; padding:12px 14px; }

  body.accessible{
    --bg1:#000; --bg2:#000; --bg3:#000;
    --panel1:#000; --panel2:#000;
    --msg1:#000; --msg2:#000;
    --btn-bg:#111; --btn-border:#fff;
  }

  .sky{
    position:fixed; inset:0; pointer-events:none; z-index:-6;
    background-image:
      radial-gradient(circle at 15% 20%, rgba(255,255,255,0.9) 1px, transparent 2px),
      radial-gradient(circle at 80% 35%, rgba(255,255,255,0.7) 1px, transparent 2px),
      radial-gradient(circle at 40% 80%, rgba(255,255,255,0.6) 1px, transparent 2px),
      radial-gradient(circle at 60% 10%, rgba(255,255,255,0.6) 1px, transparent 2px);
    background-size: 180px 180px, 220px 220px, 260px 260px, 300px 300px;
    animation: twinkle 16s linear infinite alternate;
    opacity:.45;
  }
  @keyframes twinkle{ 0%{opacity:.28; transform:translateY(0)} 50%{opacity:.72; transform:translateY(-8px)} 100%{opacity:.4; transform:translateY(6px)} }

  .snow{
    position:fixed; inset:0; pointer-events:none; z-index:-5;
    opacity: var(--snowOpacity, .55);
    background-image:
      radial-gradient(circle, rgba(255,255,255,0.6) 1px, transparent 2px),
      radial-gradient(circle, rgba(255,255,255,0.25) 1px, transparent 2px);
    background-size: var(--snowA, 140px) var(--snowA, 140px), var(--snowB, 220px) var(--snowB, 220px);
    background-position:0 0,60px 80px;
    animation:snowMove 22s linear infinite;
  }
  @keyframes snowMove{ from{transform:translateY(-20px)} to{transform:translateY(20px)} }

  .ground{
    position:fixed; left:-10%; right:-10%; bottom:-60px; height:160px; z-index:-3;
    background: radial-gradient(circle at top,#fdfefe 0,#d0dde8 45%,rgba(0,0,0,0) 70%);
    opacity:.9;
    pointer-events:none;
  }

  .wrap{width:100%;max-width:1020px}
  .board{
    position:relative;
    border-radius:28px;
    padding:20px 18px 16px;
    overflow:hidden;
    background: radial-gradient(circle at top, var(--panel1) 0, var(--panel2) 65%);
    border:6px solid #fff;
    box-shadow:0 22px 50px var(--shadow);
  }
  .board:before{
    content:"";
    position:absolute; inset:10px; border-radius:22px; padding:3px;
    background:repeating-linear-gradient(135deg,var(--frame-red) 0 14px,var(--frame-green) 14px 28px);
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;
    mask-composite:exclude;
    pointer-events:none;
    opacity:.92;
  }

  /* Hidden access zones */
  #secret-zone{ position:absolute; top:0; right:0; width:180px; height:180px; z-index:50; }
  #panic-zone{ position:absolute; bottom:0; left:0; width:130px; height:130px; z-index:50; }

  .hdr{ display:flex; gap:14px; align-items:center; margin-bottom:10px; }
  .face{ width:84px; height:84px; flex:0 0 auto; filter:drop-shadow(0 10px 14px rgba(0,0,0,.35)); }
  .title{ font-weight:950; letter-spacing:.10em; text-transform:uppercase; font-size:.9rem; color:var(--gold); }
  .sub{ font-size:1.55rem; font-weight:950; margin-top:2px; text-shadow:0 1px 4px rgba(0,0,0,.7) }
  .date{ font-size:.92rem; opacity:.9; margin-top:4px; }

  .meta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:6px 10px; border-radius:999px;
    background: rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.22);
    font-size:.85rem; font-weight:850;
    white-space:nowrap;
  }
  .pill b{ color:var(--gold); }

  .moodPill{
    background: var(--moodAccent);
    border-color: rgba(255,217,114,.45);
    position:relative;
    overflow:hidden;
  }
  .moodPill::after{
    content:"";
    position:absolute; inset:-40%;
    background: radial-gradient(circle at 20% 30%, rgba(255,255,255,.24), transparent 55%);
    transform: rotate(12deg);
    animation: moodGlow 3.5s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes moodGlow{
    0%{transform:translateX(-10px) rotate(12deg);opacity:.4}
    50%{transform:translateX(12px) rotate(12deg);opacity:.8}
    100%{transform:translateX(-10px) rotate(12deg);opacity:.4}
  }

  .msgbox{
    margin-top:10px;
    border-radius:22px;
    padding:22px 16px 14px;
    position:relative;
    overflow:hidden;
    background: radial-gradient(circle at top, var(--msg1) 0, var(--msg2) 70%);
    border:2px solid rgba(255,255,255,.2);
    box-shadow: inset 0 0 40px rgba(0,0,0,.55);
  }
  .garland{
    position:absolute; top:-14px; left:-16px; right:-16px; height:44px;
    pointer-events:none; opacity:.95;
    background-image:
      radial-gradient(circle,#ffef9a 3px,transparent 4px),
      radial-gradient(circle,#ff8080 3px,transparent 4px),
      radial-gradient(circle,#8ae6ff 3px,transparent 4px),
      radial-gradient(circle,#b5ff9a 3px,transparent 4px);
    background-size:70px 40px;
    background-position:0 22px,20px 12px,40px 26px,10px 6px;
    filter:drop-shadow(0 2px 6px rgba(0,0,0,.35));
  }
  .garland.twinkle{ animation: garlandBlink 1.2s steps(2,end) infinite; }
  @keyframes garlandBlink{
    0%{ opacity:.65; filter:drop-shadow(0 2px 6px rgba(0,0,0,.25)); }
    50%{ opacity:1; filter:drop-shadow(0 2px 12px rgba(255,255,255,.35)); }
    100%{ opacity:.8; }
  }

  .label{
    position:relative; z-index:2;
    font-size:.78rem;
    text-transform:uppercase;
    letter-spacing:.18em;
    opacity:.95;
    margin-bottom:10px;
    display:flex; justify-content:space-between; gap:10px;
    text-shadow:0 2px 10px rgba(0,0,0,.65);
  }
  .stamp{
    padding:5px 10px;
    border-radius:999px;
    background: rgba(255,217,114,.16);
    border:1px solid rgba(255,217,114,.45);
    font-weight:950;
    font-size:.68rem;
    letter-spacing:.10em;
  }

  .msg{
    margin:0;
    white-space:pre-wrap;
    line-height:1.45;
    font-weight:900;
    text-shadow:0 1px 2px rgba(0,0,0,.75),0 0 20px rgba(255,255,255,.18);
    font-size: clamp(1.2rem, 2vw + 1rem, 2rem);
    position:relative;
    z-index:2;
  }
  .msg.hand{ font-family: var(--hand); }

  .btnBig{
    margin-top:10px;
    width:100%;
    padding:14px 18px;
    border-radius:16px;
    border:none;
    background: linear-gradient(135deg,#22b36d,#178651);
    color:#fff;
    font-weight:1000;
    font-size:1.05rem;
    cursor:pointer;
    box-shadow:0 12px 26px rgba(0,0,0,.35);
  }
  .btnBig.alt{ background: linear-gradient(135deg,#4aa6ff,#2e63ff); }
  .btnBig.gray{ background: linear-gradient(135deg,#7a8496,#4b5363); }

  .card{
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    padding:12px;
  }
  .card h3{
    margin:0 0 6px 0;
    font-size:.88rem;
    letter-spacing:.10em;
    text-transform:uppercase;
    color: rgba(255,255,255,.9);
  }
  .card p{ margin:0; font-weight:850; opacity:.95; line-height:1.35; }
  .small{ font-size:.86rem; opacity:.85; }

  .row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .chip{
    padding:10px 14px;
    border-radius:999px;
    border:1px solid var(--btn-border);
    background: var(--btn-bg);
    color:#fff;
    font-weight:950;
    font-size:.78rem;
    text-transform:uppercase;
    cursor:pointer;
  }
  .chip.on{ background: rgba(255,217,114,.18); border-color: rgba(255,217,114,.55); }
  .chip:disabled{ opacity:.55; cursor:not-allowed; }

  .miniRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .miniRow > * { flex:1; min-width:180px; }
  input[type="range"]{ width:100%; }

  .stickers{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
  .st{
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    font-weight:950;
    font-size:.9rem;
  }

  .backdrop{
    position:fixed; inset:0;
    background: rgba(2,6,16,.78);
    display:none;
    align-items:center;
    justify-content:center;
    padding:14px;
    z-index:999;
  }
  .backdrop.visible{ display:flex; }

  .panel{
    width:100%;
    max-width:1000px;
    background: #071220;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.12);
    box-shadow:0 18px 40px rgba(0,0,0,.7);
    padding:14px;
    color:#f5f7fb;
    max-height: calc(100vh - 28px);
    overflow:auto;
    -webkit-user-select:text;
    user-select:text;
  }

  .panelHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .panelHeader h2{
    margin:0;
    font-size:1rem;
    letter-spacing:.10em;
    text-transform:uppercase;
    font-weight:950;
  }

  .btnG{
    font-size:1rem;
    padding:12px 16px;
    border-radius:14px;
    border:1px solid var(--btn-border);
    background: var(--btn-bg);
    color:#fff;
    font-weight:1000;
    cursor:pointer;
  }
  .btnG.primary{ background: linear-gradient(135deg,#22b36d,#178651); border:none; }
  .btnG.danger{ background: rgba(224,69,69,.18); border-color: rgba(224,69,69,.35); }

  label{ display:block; font-weight:900; margin:10px 0 6px; opacity:.95; }
  textarea, input, select{
    width:100%;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.22);
    padding:10px 12px;
    font-family:inherit;
    font-size:1rem;
    background:#050b15;
    color:#fff;
    outline:none;
  }
  textarea{ min-height:110px; resize:vertical; }

  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width: 720px){ .grid2{ grid-template-columns:1fr; } }

  /* Jumping Elf game */
  .toolbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.05);
    margin-bottom:10px;
  }
  .hud{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    font-weight:950; letter-spacing:.06em;
    font-size:.78rem; text-transform:uppercase;
  }
  .pill2{
    padding:7px 10px;
    border-radius:999px;
    background: rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,.18);
    white-space:nowrap;
  }
  .controls{ display:flex; gap:10px; flex-wrap:wrap; }

  canvas#game{
    display:block;
    width:100%;
    height:360px;
    background: linear-gradient(180deg, rgba(20,55,90,.55), rgba(0,0,0,.35));
    border-radius:14px;
    border:1px solid rgba(255,255,255,.15);
    touch-action:none;
  }
  body.zoomed canvas#game{ height:460px; }

  /* Other game canvases */
  canvas.gameCanvas{
    display:block;
    width:100%;
    height:360px;
    background: linear-gradient(180deg, rgba(20,55,90,.55), rgba(0,0,0,.35));
    border-radius:14px;
    border:1px solid rgba(255,255,255,.15);
    touch-action:none;
  }
  body.zoomed canvas.gameCanvas{ height:460px; }

  .status{
    margin-top:10px;
    text-align:center;
    font-weight:1000;
    letter-spacing:.04em;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.22);
  }
  .status b{ color: var(--gold); }

  /* Wheel */
  .wheelWrap{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:8px; }
  .wheel{
    width:min(360px, 80vw);
    height:min(360px, 80vw);
    border-radius:50%;
    border:8px solid rgba(255,255,255,.85);
    box-shadow: 0 18px 40px rgba(0,0,0,.55);
    position:relative;
    background:
      conic-gradient(
        rgba(255,217,114,.95) 0 45deg,
        rgba(74,166,255,.95) 45deg 90deg,
        rgba(34,179,109,.95) 90deg 135deg,
        rgba(224,69,69,.95) 135deg 180deg,
        rgba(168,122,255,.95) 180deg 225deg,
        rgba(255,149,90,.95) 225deg 270deg,
        rgba(120,200,255,.95) 270deg 315deg,
        rgba(255,239,154,.95) 315deg 360deg
      );
    transform: rotate(var(--wheelRot, 0deg));
    transition: transform 3.3s cubic-bezier(.12,.88,.12,1);
    overflow:hidden;
  }
  .wheel::after{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(circle at 50% 50%, rgba(0,0,0,.15), transparent 55%),
      radial-gradient(circle at 50% 50%, rgba(255,255,255,.18), transparent 70%);
    pointer-events:none;
  }
  .wheelCenter{
    width:84px;height:84px;border-radius:50%;
    background: rgba(0,0,0,.35);
    border:2px solid rgba(255,255,255,.35);
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    display:flex; align-items:center; justify-content:center;
    font-weight:1000;
    letter-spacing:.08em;
    text-transform:uppercase;
    font-size:.8rem;
    text-align:center;
  }
  .pointer{
    width:0;height:0;
    border-left:16px solid transparent;
    border-right:16px solid transparent;
    border-top:26px solid rgba(255,255,255,.9); /* ‚úÖ arrow points DOWN toward wheel */
    filter: drop-shadow(0 10px 10px rgba(0,0,0,.45));
  }

  /* Advent */
  .adventGrid{
    display:grid;
    grid-template-columns: repeat(6, 1fr);
    gap:10px;
    margin-top:10px;
  }
  @media (max-width: 720px){ .adventGrid{ grid-template-columns: repeat(4,1fr);} }
  .door{
    border-radius:14px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    padding:12px 10px;
    text-align:center;
    font-weight:1000;
    cursor:pointer;
    position:relative;
    min-height:54px;
    display:flex; align-items:center; justify-content:center;
  }
  .door.open{ background: rgba(255,217,114,.16); border-color: rgba(255,217,114,.45); }
  .door.locked{ opacity:.55; cursor:not-allowed; }
  .door small{ position:absolute; bottom:8px; left:0; right:0; opacity:.75; font-weight:900; font-size:.72rem; }

  /* Nice list hearts */
  .hearts{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .heart{ font-size:1.25rem; filter: drop-shadow(0 8px 10px rgba(0,0,0,.35)); }

  /* Games Hub + Memory + Tree styles ... (unchanged) */
  #gamesHubBackdrop .btnBig{ margin-top:8px; }
  .mmGrid{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
    margin-top:10px;
  }
  @media (max-width:720px){
    .mmGrid{ grid-template-columns: repeat(4,1fr); }
  }
  .mmCard{
    border-radius:16px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    min-height:72px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.7rem;
    font-weight:1000;
    cursor:pointer;
    position:relative;
    user-select:none;
  }
  .mmCard.revealed{
    background: rgba(255,217,114,.16);
    border-color: rgba(255,217,114,.45);
  }
  .mmCard.matched{
    background: rgba(34,179,109,.18);
    border-color: rgba(34,179,109,.45);
    cursor:default;
  }
  .mmCard .mmBack{ opacity:.95; }
  .mmCard .mmFace{
    position:absolute; inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    opacity:0;
    transform:scale(.96);
    transition: opacity .12s ease, transform .12s ease;
  }
  .mmCard.revealed .mmFace,
  .mmCard.matched .mmFace{
    opacity:1; transform:1;
  }
  .mmCard.revealed .mmBack,
  .mmCard.matched .mmBack{ opacity:0; }

  .dtWrap{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:12px;
    margin-top:10px;
  }
  @media (max-width:720px){
    .dtWrap{ grid-template-columns: 1fr; }
  }
  .dtTree{
    position:relative;
    min-height:360px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.05);
    overflow:hidden;
  }
  .dtTree::before{
    content:"";
    position:absolute; left:50%; top:55%;
    width:0; height:0;
    border-left:140px solid transparent;
    border-right:140px solid transparent;
    border-bottom:240px solid rgba(34,179,109,.45);
    transform:translate(-50%,-50%);
    filter: drop-shadow(0 18px 22px rgba(0,0,0,.25));
  }
  .dtTree::after{
    content:"";
    position:absolute; left:50%; bottom:26px;
    width:62px; height:56px;
    transform:translateX(-50%);
    border-radius:10px;
    background: rgba(120,74,40,.6);
    border:1px solid rgba(255,255,255,.12);
  }
  .dtTreeTop{
    position:absolute;
    left:50%; top:14px;
    transform:translateX(-50%);
    font-size:2rem;
    filter: drop-shadow(0 10px 12px rgba(0,0,0,.35));
  }
  .dtOrnaments{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    align-content:flex-start;
    padding:10px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
    min-height:200px;
  }
  .dtOrn{
    width:54px; height:54px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.08);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.8rem;
    cursor:grab;
    user-select:none;
  }
  .dtPlaced{
    position:absolute;
    width:44px; height:44px;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.45rem;
    background: rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.20);
    transform: translate(-50%,-50%);
    filter: drop-shadow(0 12px 14px rgba(0,0,0,.35));
  }

  .dbg { display:none; margin-top:10px; font-size:.8rem; opacity:.8; }
  .dbg.on { display:block; }
</style>
</head>

<body>
<div class="sky"></div>
<div class="snow" id="snowLayer"></div>
<div class="ground"></div>

<div class="wrap">
  <div class="board" id="board">
    <div id="secret-zone" aria-hidden="true"></div>
    <div id="panic-zone" aria-hidden="true"></div>

    <div class="hdr">
      <div class="face" aria-hidden="true">
        <!-- elf face svg unchanged -->
        <svg viewBox="0 0 160 160" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="hat" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#20c06c"/>
              <stop offset="1" stop-color="#0c6b3a"/>
            </linearGradient>
          </defs>
          <path d="M40 65 C55 20, 115 20, 120 70 C104 62, 75 58, 40 65Z" fill="url(#hat)"/>
          <rect x="36" y="63" width="92" height="14" rx="7" fill="#f2f5f7"/>
          <circle cx="122" cy="75" r="8" fill="#ffd972"/>
          <ellipse cx="80" cy="95" rx="40" ry="34" fill="#ffd9b4"/>
          <circle cx="64" cy="92" r="6" fill="#1f2230"/>
          <circle cx="96" cy="92" r="6" fill="#1f2230"/>
          <path d="M65 110 C75 122, 85 122, 95 110" fill="none" stroke="#b55652" stroke-width="4" stroke-linecap="round"/>
        </svg>
      </div>

      <div style="flex:1;min-width:0">
        <div class="title">A Message From</div>
        <div class="sub">Jingles & Bells</div>
        <div class="date" id="dateLabel"></div>
        <div class="meta">
          <div class="pill">üéÅ Christmas in <b id="countdown">--</b></div>
          <div class="pill moodPill" id="moodPill">üôÇ Mood: <b id="moodText">--</b></div>
          <div class="pill">‚≠ê Stickers <b id="stickerCount">0</b></div>
          <div class="pill">üèÜ Daily best <b id="dailyBestMini">0</b></div>
          <div class="pill">ü™ô Coins <b id="coinsMini">0</b></div>
        </div>
      </div>
    </div>

    <div class="msgbox">
      <div class="garland" id="garland"></div>

      <div class="label">
        <span>Elf‚Äôs Note To Alexa</span>
        <span class="stamp" id="stamp">Official Elf Note</span>
      </div>

      <p class="msg" id="msg"></p>

      <button class="btnBig" id="openGamesHubFront" type="button">üïπÔ∏è Open Games Hub</button>
      <button class="btnBig alt" id="openExtras" type="button">‚ú® Fun & Extras</button>
    </div>
  </div>
</div>

<!-- Extras Popup -->
<div class="backdrop" id="extrasBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <h2>Fun & Extras</h2>
      <button class="btnG danger" id="closeExtras" type="button">‚úñ Close</button>
    </div>

    <div class="card">
      <h3>Jingles & Bells Mood</h3>
      <p>Today they‚Äôre feeling: <b id="moodText2">--</b></p>
      <p class="small" id="moodHint">‚Äî</p>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Spin The Wheel (1 per day)</h3>
      <p class="small">Win coins, stickers, or a little game boost.</p>
      <div class="row">
        <button class="chip" id="openWheel" type="button">üé° Open Wheel</button>
        <button class="chip" id="wheelStatus" type="button" disabled>Spin Available</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Advent Calendar</h3>
      <p class="small">Open doors 1‚Äì24 up to today‚Äôs date.</p>
      <div class="row">
        <button class="chip" id="openAdvent" type="button">üóìÔ∏è Open Advent</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Nice List</h3>
      <p class="small">Each kind thing adds a heart for today.</p>
      <div class="row">
        <button class="chip" id="addHeart" type="button">üíó I Did A Kind Thing</button>
        <button class="chip" id="resetHearts" type="button">Reset Hearts</button>
      </div>
      <div class="hearts" id="hearts"></div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Daily Challenge</h3>
      <p id="challengeText">---</p>
      <div class="row">
        <button class="chip" id="challengeDone" type="button">I Did It ‚úÖ</button>
        <button class="chip" id="challengeNew" type="button">New Challenge üîÅ</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Stickers</h3>
      <p class="small">Earn stickers from challenges, wheel prizes, and game milestones.</p>
      <div class="stickers" id="stickers"></div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Jokes & Riddles</h3>
      <div class="row">
        <button class="chip" id="jokeBtn" type="button">Joke ü§≠</button>
        <button class="chip" id="riddleBtn" type="button">Riddle üß©</button>
        <button class="chip" id="surpriseBtn" type="button">Surprise üéÅ</button>
      </div>
      <p id="funOutput" style="margin-top:10px">Tap a button to reveal something!</p>
    </div>

    <div class="card" style="margin-top:10px">
      <h3>Effects & Display</h3>
      <div class="row">
        <button class="chip" id="handBtn" type="button">Handwriting: Off</button>
        <button class="chip on" id="stampBtn" type="button">Stamp: On</button>
        <button class="chip on" id="twinkleBtn" type="button">Twinkle: On</button>
        <button class="chip on" id="snowBtn" type="button">Snow: On</button>
        <button class="chip" id="bigTextBtn" type="button">Big Text: Off</button>
        <button class="chip" id="accessBtn" type="button">Accessibility: Off</button>
        <button class="chip" id="perfBtn" type="button">Performance: Normal</button>
      </div>

      <div class="miniRow" style="margin-top:10px">
        <input id="snowRange" type="range" min="0" max="100" value="55"/>
        <div class="pill">‚ùÑÔ∏è <b id="snowVal">55</b>%</div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="chip" id="soundToggle" type="button">üîä Sound: On</button>
      </div>

      <p class="small">Parents/Admin is hidden: press and hold top-right for 5 seconds. Panic close: triple tap bottom-left.</p>
    </div>
  </div>
</div>

<!-- Wheel Modal -->
<div class="backdrop" id="wheelBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:920px">
    <div class="panelHeader">
      <h2>Spin The Wheel</h2>
      <button class="btnG danger" id="closeWheel" type="button">‚úñ Close</button>
    </div>

    <div class="wheelWrap">
      <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
        <div class="pointer"></div>
        <div class="wheel" id="wheel">
          <div class="wheelCenter">Elf<br/>Wheel</div>
        </div>
      </div>

      <div style="min-width:min(360px,90vw);max-width:420px">
        <div class="card">
          <h3>Prize</h3>
          <p id="wheelResult">Tap ‚ÄúSpin‚Äù!</p>
          <p class="small" id="wheelNote">You can spin once per day.</p>
        </div>
        <div class="row" style="justify-content:center">
          <button class="btnG primary" id="spinBtn" type="button">üé° Spin</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Advent Modal -->
<div class="backdrop" id="adventBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:980px">
    <div class="panelHeader">
      <h2>Advent Calendar</h2>
      <button class="btnG danger" id="closeAdvent" type="button">‚úñ Close</button>
    </div>
    <p class="small" id="adventHint">Open doors up to today‚Äôs date.</p>
    <div class="adventGrid" id="adventGrid"></div>
    <div class="card" style="margin-top:10px">
      <h3>Surprise</h3>
      <p id="adventOut">Pick a door!</p>
    </div>
  </div>
</div>

<!-- Jumping Elf Game Popup -->
<div class="backdrop" id="gameBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="toolbar">
      <button class="btnG danger" id="closeGame" type="button">‚úñ Close</button>

      <div class="hud">
        <span class="pill2">Score: <span id="score">0</span></span>
        <span class="pill2">Level: <span id="level">1</span></span>
        <span class="pill2">Coins(run): <span id="coins">0</span></span>
        <span class="pill2">Daily Best: <span id="dailyBest">0</span></span>
        <span class="pill2">Lives: <span id="lives">‚ù§‚ù§‚ù§</span></span>
      </div>

      <div class="controls">
        <button class="btnG" id="zoomBtn" type="button">‚õ∂ Big Mode</button>
        <button class="btnG primary" id="startBtn" type="button">‚ñ∂ Start</button>
        <button class="btnG primary" id="jumpBtn" type="button" disabled>‚¨ÜÔ∏è Jump</button>
      </div>
    </div>

    <canvas id="game"></canvas>

    <div class="status" id="status">
      Tap <b>Start</b>, then tap the game (or <b>Jump</b>) to jump.
    </div>
  </div>
</div>

<!-- Games Hub -->
<div class="backdrop" id="gamesHubBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:980px">
    <div class="panelHeader">
      <h2>Games Hub</h2>
      <button class="btnG danger" id="closeGamesHub" type="button">‚úñ Close</button>
    </div>

    <div class="card">
      <h3>Pick a game</h3>
      <div class="row">
        <button class="btnBig" id="openJumpingElfFromHub" type="button">üßù Jumping Elf (Jingles & Bells)</button>

        <button class="btnBig alt" id="openGame1" type="button">üéÅ Present Catcher</button>
        <button class="btnBig" id="openGame2" type="button">üß† Memory Match</button>
        <button class="btnBig alt" id="openGame3" type="button">‚ùÑÔ∏è Snowball Pop</button>
        <button class="btnBig" id="openGame4" type="button">üç¨ Candy Cane Runner</button>
        <button class="btnBig gray" id="openGame5" type="button">üéÑ Decorate the Tree</button>
      </div>
      <p class="small" style="margin-top:10px">Tip: sound uses the main Sound toggle.</p>
    </div>
  </div>
</div>

<!-- GAME 1: Present Catcher -->
<div class="backdrop" id="presentBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <h2>üéÅ Present Catcher</h2>
      <button class="btnG danger" id="closePresent" type="button">‚úñ Close</button>
    </div>
    <div class="toolbar">
      <div class="hud">
        <span class="pill2">Score: <span id="pcScore">0</span></span>
        <span class="pill2">Misses: <span id="pcMiss">0</span>/3</span>
        <span class="pill2">Level: <span id="pcLevel">1</span></span>
        <span class="pill2">Best: <span id="pcBest">0</span></span>
      </div>
      <div class="controls">
        <button class="btnG primary" id="pcStart" type="button">‚ñ∂ Start</button>
      </div>
    </div>
    <canvas class="gameCanvas" id="pcCanvas"></canvas>
    <div class="status" id="pcStatus">Drag left/right to move. Catch üéÅ, don‚Äôt miss 3!</div>
  </div>
</div>

<!-- GAME 2: Memory Match -->
<div class="backdrop" id="memoryBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:980px">
    <div class="panelHeader">
      <h2>üß† Memory Match</h2>
      <button class="btnG danger" id="closeMemory" type="button">‚úñ Close</button>
    </div>

    <div class="toolbar">
      <div class="hud">
        <span class="pill2">Moves: <span id="mmMoves">0</span></span>
        <span class="pill2">Matches: <span id="mmMatches">0</span>/<span id="mmTotal">8</span></span>
        <span class="pill2">Time: <span id="mmTime">0</span>s</span>
        <span class="pill2">Best: <span id="mmBest">--</span></span>
      </div>
      <div class="controls">
        <button class="btnG primary" id="mmNew" type="button">üîÅ New Game</button>
        <button class="btnG" id="mmHard" type="button">Difficulty: Normal</button>
      </div>
    </div>

    <div class="mmGrid" id="mmGrid"></div>
    <div class="status" id="mmStatus">Find all the pairs!</div>
  </div>
</div>

<!-- GAME 3: Snowball Pop -->
<div class="backdrop" id="snowBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <h2>‚ùÑÔ∏è Snowball Pop</h2>
      <button class="btnG danger" id="closeSnow" type="button">‚úñ Close</button>
    </div>
    <div class="toolbar">
      <div class="hud">
        <span class="pill2">Score: <span id="spScore">0</span></span>
        <span class="pill2">Misses: <span id="spMiss">0</span>/5</span>
        <span class="pill2">Level: <span id="spLevel">1</span></span>
        <span class="pill2">Best: <span id="spBest">0</span></span>
      </div>
      <div class="controls">
        <button class="btnG primary" id="spStart" type="button">‚ñ∂ Start</button>
      </div>
    </div>
    <canvas class="gameCanvas" id="spCanvas"></canvas>
    <div class="status" id="spStatus">Tap snowballs to pop them. Avoid the green ‚ÄúGrinch‚Äù one!</div>
  </div>
</div>

<!-- GAME 4: Candy Cane Runner -->
<div class="backdrop" id="runnerBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <h2>üç¨ Candy Cane Runner</h2>
      <button class="btnG danger" id="closeRunner" type="button">‚úñ Close</button>
    </div>
    <div class="toolbar">
      <div class="hud">
        <span class="pill2">Score: <span id="crScore">0</span></span>
        <span class="pill2">Level: <span id="crLevel">1</span></span>
        <span class="pill2">Best: <span id="crBest">0</span></span>
      </div>
      <div class="controls">
        <button class="btnG primary" id="crStart" type="button">‚ñ∂ Start</button>
        <button class="btnG primary" id="crSwitch" type="button" disabled>‚¨ÜÔ∏é Switch Lane</button>
      </div>
    </div>
    <canvas class="gameCanvas" id="crCanvas"></canvas>
    <div class="status" id="crStatus">Tap Switch (or tap the game) to change lanes and avoid obstacles.</div>
  </div>
</div>

<!-- GAME 5: Decorate the Tree -->
<div class="backdrop" id="treeBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:980px">
    <div class="panelHeader">
      <h2>üéÑ Decorate the Tree</h2>
      <button class="btnG danger" id="closeTree" type="button">‚úñ Close</button>
    </div>

    <div class="toolbar">
      <div class="hud">
        <span class="pill2">Placed: <span id="dtPlaced">0</span></span>
        <span class="pill2">Time: <span id="dtTime">30</span>s</span>
        <span class="pill2">Best: <span id="dtBest">0</span></span>
      </div>
      <div class="controls">
        <button class="btnG primary" id="dtStart" type="button">‚ñ∂ Start</button>
        <button class="btnG" id="dtReset" type="button">üîÅ Reset</button>
      </div>
    </div>

    <div class="dtWrap">
      <div class="dtTree" id="dtTree">
        <div class="dtTreeTop">‚≠ê</div>
      </div>
      <div class="dtOrnaments" id="dtOrnaments" aria-label="Ornaments tray"></div>
    </div>

    <div class="status" id="dtStatus">Drag ornaments onto the tree (or tap an ornament) before time runs out!</div>
  </div>
</div>

<!-- PIN Modal -->
<div class="backdrop" id="pinBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" style="max-width:720px">
    <div class="panelHeader">
      <h2>Parents Only</h2>
      <button class="btnG danger" id="pinClose" type="button">Close</button>
    </div>
    <p class="small">Enter the PIN to open settings.</p>
    <div class="miniRow">
      <input id="pinInput" type="password" inputmode="numeric" maxlength="8" placeholder="PIN"/>
      <button class="btnG primary" id="pinOk" type="button">OK</button>
    </div>
    <div id="pinErr" style="margin-top:10px;color:#ffb3b3;font-weight:900;min-height:1.2em"></div>
    <p class="small">Hidden access: press and hold top-right for 5 seconds. Panic close: triple tap bottom-left.</p>
  </div>
</div>

<!-- Admin Modal -->
<div class="backdrop" id="adminBackdrop" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <h2>Jingles & Bells ‚Äî Settings</h2>
      <button class="btnG danger" id="adminClose" type="button">Close</button>
    </div>

    <label>Default message</label>
    <textarea id="adminMsg"></textarea>

    <div class="grid2">
      <div>
        <label>Set message for a date (YYYY-MM-DD)</label>
        <input id="schedDate" type="text" placeholder="2025-12-10"/>
      </div>
      <div>
        <label>Scheduled message text</label>
        <input id="schedText" type="text" placeholder="Your message from Jingles & Bells"/>
      </div>
    </div>

    <div class="miniRow" style="margin-top:10px">
      <button class="btnG primary" id="saveToday" type="button">Save Default Message</button>
      <button class="btnG primary" id="saveScheduled" type="button">Save Scheduled</button>
      <button class="btnG" id="clearScheduled" type="button">Clear Scheduled for Date</button>
    </div>

    <label>PIN (4‚Äì8 digits)</label>
    <div class="miniRow">
      <input id="newPin" type="password" inputmode="numeric" placeholder="New PIN"/>
      <button class="btnG primary" id="setPin" type="button">Change PIN</button>
    </div>

    <label>Export / Import</label>
    <p class="small">Export gives a copy/paste code. Import replaces current settings.</p>
    <div class="miniRow">
      <button class="btnG" id="exportBtn" type="button">Export</button>
      <button class="btnG danger" id="importBtn" type="button">Import</button>
    </div>
    <textarea id="backupBox" placeholder="Backup code appears here..."></textarea>

    <label>Admin actions</label>
    <div class="row" style="margin-top:6px">
      <button class="chip" id="resetDayBtn" type="button">Reset Today (challenge+stickers)</button>
      <button class="chip" id="factoryBtn" type="button" style="border-color:rgba(224,69,69,.45)">Factory Reset</button>
    </div>

    <p class="small">Admin auto-closes after 45 seconds of no activity.</p>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // Small error overlay
  (function(){
    const box = document.createElement("div");
    box.id = "errBox";
    box.style.cssText = "position:fixed;left:10px;right:10px;bottom:10px;z-index:99999;background:rgba(0,0,0,.75);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:10px 12px;font:12px/1.35 system-ui;max-height:30vh;overflow:auto;display:none;";
    document.body.appendChild(box);
    const show = (msg)=>{
      box.style.display="block";
      box.innerHTML="<b>App error:</b><br>"+String(msg).replace(/</g,"&lt;")+"<hr style='opacity:.2'>"+box.innerHTML;
    };
    window.addEventListener("error",(e)=>show(e.message+" @ "+(e.filename||"")+":"+(e.lineno||"")));
    window.addEventListener("unhandledrejection",(e)=>show((e.reason&&e.reason.message)?e.reason.message:e.reason));
  })();

  // Storage (fallback)
  let storageOK = true;
  const mem = {};
  try{ localStorage.setItem("__t","1"); localStorage.removeItem("__t"); }catch{ storageOK=false; }
  const get=(k,fb)=>{ try{ return storageOK?(localStorage.getItem(k)??fb):(mem[k]??fb);}catch{return fb;}};
  const set=(k,v)=>{ try{ storageOK?localStorage.setItem(k,v):mem[k]=String(v);}catch{} };

  const KEYS = {
    pin: "elf_pin_v4",
    msgDefault: "elf_msg_default_v4",
    msgByDate: "elf_msg_by_date_v4",
    hand: "elf_hand_v4",
    stamp: "elf_stamp_v4",
    twinkle: "elf_twinkle_v4",
    snowOn: "elf_snow_on_v4",
    snowPct: "elf_snow_pct_v4",
    bigText: "elf_bigtext_v4",
    access: "elf_access_v4",
    sound: "elf_sound_v4",

    dayKey: "elf_daykey_v4",
    challengeKey: "elf_challenge_v4",
    stickersKey: "elf_stickers_v4",

    dailyBestAll: "elf_dailybest_all_v4",
    coins: "elf_coins_v4",

    mood: "elf_mood_v4",
    wheelDay: "elf_wheel_day_v4",
    wheelDone: "elf_wheel_done_v4",

    hearts: "elf_hearts_v4",
    advent: "elf_advent_open_v4",

    perf: "elf_perf_v4",
  };

  const pad2 = n=>String(n).padStart(2,"0");
  const ymd = d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const todayKey=()=>ymd(new Date());

  // Audio
  let soundOn = get(KEYS.sound,"1")!=="0";
  let audioCtx=null;
  function ensureAudio(){
    if(!audioCtx){
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return null;
      audioCtx = new Ctx();
    }
    if(audioCtx.state==="suspended") audioCtx.resume().catch(()=>{});
    return audioCtx;
  }
  function beep(freq=660,ms=70,type="triangle"){
    if(!soundOn) return;
    const ctx = ensureAudio(); if(!ctx) return;
    const t0 = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type=type;
    o.frequency.setValueAtTime(freq,t0);
    g.gain.setValueAtTime(0.0001,t0);
    g.gain.exponentialRampToValueAtTime(0.06,t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t0+ms/1000);
    o.connect(g); g.connect(ctx.destination);
    o.start(t0); o.stop(t0+ms/1000+0.03);
  }
  window.addEventListener("touchstart",()=>ensureAudio(),{passive:true,once:true});
  window.addEventListener("mousedown",()=>ensureAudio(),{once:true});
  function syncSoundButton(){
    $("soundToggle").textContent = soundOn ? "üîä Sound: On" : "üîá Sound: Off";
    set(KEYS.sound, soundOn ? "1" : "0");
  }

  // Layout helpers
  function forceLayout(){ document.body.offsetHeight; }
  async function fitCanvasSafe(canvasEl, tries=20){
    let r = canvasEl.getBoundingClientRect();
    while((r.width<20||r.height<20)&&tries-- >0){
      await new Promise(res=>setTimeout(res,80));
      forceLayout();
      r = canvasEl.getBoundingClientRect();
    }
    const dpr = Math.max(1,Math.min(2,window.devicePixelRatio||1));
    canvasEl.width = Math.max(1,Math.floor(r.width*dpr));
    canvasEl.height = Math.max(1,Math.floor(r.height*dpr));
    const c = canvasEl.getContext("2d",{alpha:true});
    c.setTransform(dpr,0,0,dpr,0,0);
    canvasEl.style.touchAction="none";
    return c;
  }

  // Countdown
  function nextXmas(now){
    const y = now.getFullYear();
    const x = new Date(y,11,25,0,0,0,0);
    return now<=x?x:new Date(y+1,11,25,0,0,0,0);
  }
  function tickCountdown(){
    const now = new Date();
    const x = nextXmas(now);
    const diff=x-now;
    if(diff<=0){ $("countdown").textContent="Merry Christmas!"; return;}
    const s=Math.floor(diff/1000);
    const days=Math.floor(s/86400);
    const hrs=Math.floor((s%86400)/3600);
    const mins=Math.floor((s%3600)/60);
    const secs=s%60;
    $("countdown").textContent=`${days}d ${hrs}h ${mins}m ${secs}s`;
  }

  // Messages
  function readMap(key){ try{return JSON.parse(get(key,"{}"))||{};}catch{return{}};}
  function writeMap(key,obj){ try{set(key,JSON.stringify(obj));}catch{} }
  function getMessageForToday(){
    const t=todayKey();
    const map=readMap(KEYS.msgByDate);
    if(map[t]) return map[t];
    return get(KEYS.msgDefault,
      "Hello Alexa! üéÑ‚ú®\n\nToday‚Äôs mission from Jingles & Bells:\n‚Ä¢ Be kind\n‚Ä¢ Help someone\n‚Ä¢ Do your best listening\n\nLove,\nJingles & Bells üíö"
    );
  }
  function renderMessage(){ $("msg").textContent=getMessageForToday(); }

  // Daily seed, challenges, stickers, hearts, moods etc
  const CHALLENGES=[/* unchanged */"Find 3 red things in the house üéà","Do 10 star jumps ‚≠ê","Draw a snowman and show it to a grown-up ‚õÑ","Say 3 kind things to someone üíõ","Make your bed like a tidy elf üõèÔ∏è","Help with one small job (shoes, toys, table) üßπ","Sing a Christmas song (even a silly one!) üé∂","Write a thank-you note (or draw one) ‚úçÔ∏è","Read a story with someone üìö","Make a reindeer face in the mirror ü¶å"];
  const STICKERS=["‚≠ê","üéÅ","üç¨","ü¶å","üéÑ","‚ùÑÔ∏è","‚ú®","üèÖ","üß∏","üéÖ","ü™ô","üíó"];

  function ensureDaily(){
    const t=todayKey();
    if(get(KEYS.dayKey,"")!==t){
      set(KEYS.dayKey,t);
      const pick=CHALLENGES[(Math.random()*CHALLENGES.length)|0];
      set(KEYS.challengeKey,JSON.stringify({day:t,text:pick,done:false}));
      set(KEYS.stickersKey,JSON.stringify({day:t,list:[]}));
      set(KEYS.hearts,JSON.stringify({day:t,count:0}));
      set(KEYS.wheelDay,t);
      set(KEYS.wheelDone,"0");
    }
  }
  function readChallenge(){ ensureDaily(); try{return JSON.parse(get(KEYS.challengeKey,"{}"))||{};}catch{return{};} }
  function writeChallenge(o){ set(KEYS.challengeKey,JSON.stringify(o)); }
  function readStickers(){ ensureDaily(); try{return JSON.parse(get(KEYS.stickersKey,"{}"))||{day:todayKey(),list:[]};}catch{return{day:todayKey(),list:[]};} }
  function writeStickers(o){ set(KEYS.stickersKey,JSON.stringify(o)); }

  function addSticker(reason="Nice!"){
    const s=readStickers();
    if(s.day!==todayKey()){ ensureDaily(); return addSticker(reason); }
    const emoji=STICKERS[(Math.random()*STICKERS.length)|0];
    s.list.push(emoji);
    writeStickers(s);
    renderStickers();
    $("funOutput").textContent=`You earned a sticker ${emoji} ‚Äî ${reason}`;
    beep(920,70,"sine");
  }
  function renderStickers(){
    const s=readStickers();
    $("stickerCount").textContent=String(s.list.length);
    const box=$("stickers"); box.innerHTML="";
    s.list.slice(-24).forEach(e=>{
      const el=document.createElement("div"); el.className="st"; el.textContent=e; box.appendChild(el);
    });
  }
  function renderChallenge(){
    const c=readChallenge();
    $("challengeText").textContent=c.text||"Tap ‚ÄúNew Challenge‚Äù";
    $("challengeDone").textContent=c.done?"Done ‚úÖ (Nice!)":"I Did It ‚úÖ";
    $("challengeDone").classList.toggle("on",!!c.done);
  }

  function readHearts(){ ensureDaily(); try{return JSON.parse(get(KEYS.hearts,"{}"))||{day:todayKey(),count:0};}catch{return{day:todayKey(),count:0};} }
  function writeHearts(o){ set(KEYS.hearts,JSON.stringify(o)); }
  function renderHearts(){
    const h=readHearts();
    const box=$("hearts"); box.innerHTML="";
    for(let i=0;i<Math.min(24,h.count|0);i++){
      const d=document.createElement("div"); d.className="heart"; d.textContent="üíó"; box.appendChild(d);
    }
  }

  const MOODS=[{name:"Silly",emoji:"üòú",accent:"rgba(255,149,90,.22)",hint:"Jingles & Bells might play a tiny prank today‚Ä¶"},
               {name:"Sneaky",emoji:"üïµÔ∏è",accent:"rgba(74,166,255,.20)",hint:"Extra sneaky footsteps today!"},
               {name:"Happy",emoji:"üòä",accent:"rgba(34,179,109,.20)",hint:"Super cheerful ‚Äî kindness time!"},
               {name:"Sleepy",emoji:"üò¥",accent:"rgba(168,122,255,.20)",hint:"Sleepy vibes ‚Äî whisper voices help!"},
               {name:"Sparkly",emoji:"‚ú®",accent:"rgba(255,217,114,.22)",hint:"Sparkly day ‚Äî try something creative!"}];
  function hashStr(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619);} return h>>>0;}
  function getTodayMood(){
    const day=todayKey();
    const saved=get(KEYS.mood,"");
    if(saved){ try{ const o=JSON.parse(saved); if(o&&o.day===day) return o;}catch{} }
    const idx=hashStr(day+"|elfmood")%MOODS.length;
    const m=MOODS[idx];
    const out={day,idx,...m};
    set(KEYS.mood,JSON.stringify(out));
    return out;
  }
  function renderMood(){
    const m=getTodayMood();
    document.body.style.setProperty("--moodAccent",m.accent);
    $("moodText").textContent=`${m.emoji} ${m.name}`;
    $("moodText2").textContent=`${m.emoji} ${m.name}`;
    $("moodHint").textContent=m.hint;
  }

  function getCoins(){ return Math.max(0,parseInt(get(KEYS.coins,"0"),10)||0); }
  function setCoins(v){ set(KEYS.coins,String(Math.max(0,v|0))); }
  function addCoins(n,reason="Coins!"){
    const next=getCoins()+(n|0);
    setCoins(next);
    refreshMini();
    $("funOutput").textContent=`${reason} You got ü™ô +${n}!`;
    beep(980,55,"sine");
  }

  function readNumMap(key){ try{return JSON.parse(get(key,"{}"))||{};}catch{return{}}; }
  function writeNumMap(key,obj){ try{set(key,JSON.stringify(obj));}catch{} }
  function getDailyBestAll(){
    const map=readNumMap(KEYS.dailyBestAll);
    return (map[todayKey()]||0)|0;
  }
  function setDailyBestAll(val){
    const map=readNumMap(KEYS.dailyBestAll);
    const t=todayKey();
    map[t]=Math.max(map[t]||0,val|0);
    writeNumMap(KEYS.dailyBestAll,map);
  }
  function refreshMini(){
    $("dailyBestMini").textContent=String(getDailyBestAll());
    $("coinsMini").textContent=String(getCoins());
  }

  function applyPrefs(){
    const hand=get(KEYS.hand,"0")==="1";
    const stampOn=get(KEYS.stamp,"1")!=="0";
    const twinkleOn=get(KEYS.twinkle,"1")!=="0";
    const snowOn=get(KEYS.snowOn,"1")!=="0";
    const snowPct=Math.max(0,Math.min(100,parseInt(get(KEYS.snowPct,"55"),10)||55));
    const big=get(KEYS.bigText,"0")==="1";
    const acc=get(KEYS.access,"0")==="1";
    const perf=get(KEYS.perf,"0")==="1";

    $("msg").classList.toggle("hand",hand);
    $("stamp").style.display=stampOn?"inline-block":"none";
    $("garland").classList.toggle("twinkle",twinkleOn&&!perf);

    const snowLayer=$("snowLayer");
    snowLayer.style.display=(snowOn&&!perf)?"block":"none";

    $("snowRange").value=String(snowPct);
    $("snowVal").textContent=String(snowPct);

    const a=240-Math.round(snowPct*1.2);
    const b=360-Math.round(snowPct*1.8);
    const op=0.15+(snowPct/100)*0.75;
    snowLayer.style.setProperty("--snowA",`${Math.max(60,a)}px`);
    snowLayer.style.setProperty("--snowB",`${Math.max(90,b)}px`);
    snowLayer.style.setProperty("--snowOpacity",String(op));

    $("handBtn").textContent="Handwriting: "+(hand?"On":"Off");
    $("handBtn").classList.toggle("on",hand);

    $("stampBtn").textContent="Stamp: "+(stampOn?"On":"Off");
    $("stampBtn").classList.toggle("on",stampOn);

    $("twinkleBtn").textContent="Twinkle: "+(twinkleOn?"On":"Off");
    $("twinkleBtn").classList.toggle("on",twinkleOn);

    $("snowBtn").textContent="Snow: "+(snowOn?"On":"Off");
    $("snowBtn").classList.toggle("on",snowOn);

    $("bigTextBtn").textContent="Big Text: "+(big?"On":"Off");
    $("bigTextBtn").classList.toggle("on",big);

    $("accessBtn").textContent="Accessibility: "+(acc?"On":"Off");
    $("accessBtn").classList.toggle("on",acc);

    $("perfBtn").textContent="Performance: "+(perf?"High":"Normal");
    $("perfBtn").classList.toggle("on",perf);

    document.body.classList.toggle("bigtext",big);
    document.body.classList.toggle("accessible",acc);

    syncSoundButton();
  }

  const openBackdrop=el=>{ el.classList.add("visible"); el.setAttribute("aria-hidden","false"); requestAnimationFrame(()=>forceLayout()); };
  const closeBackdrop=el=>{ el.classList.remove("visible"); el.setAttribute("aria-hidden","true"); };
  const backdropClickClose=el=>el.addEventListener("click",e=>{ if(e.target===el) closeBackdrop(el); });

  const extrasBackdrop=$("extrasBackdrop");
  const wheelBackdrop=$("wheelBackdrop");
  const adventBackdrop=$("adventBackdrop");
  const gameBackdrop=$("gameBackdrop");
  const pinBackdrop=$("pinBackdrop");
  const adminBackdrop=$("adminBackdrop");
  const gamesHubBackdrop=$("gamesHubBackdrop");
  const presentBackdrop=$("presentBackdrop");
  const memoryBackdrop=$("memoryBackdrop");
  const snowBackdrop=$("snowBackdrop");
  const runnerBackdrop=$("runnerBackdrop");
  const treeBackdrop=$("treeBackdrop");

  [extrasBackdrop,wheelBackdrop,adventBackdrop,gameBackdrop,pinBackdrop,adminBackdrop,
   gamesHubBackdrop,presentBackdrop,memoryBackdrop,snowBackdrop,runnerBackdrop,treeBackdrop].forEach(backdropClickClose);

  // Wheel
  const WHEEL=[
    {label:"ü™ô +10 coins",apply:()=>addCoins(10,"Wheel win!")},
    {label:"‚≠ê +1 sticker",apply:()=>addSticker("Wheel win!")},
    {label:"ü™ô +25 coins",apply:()=>addCoins(25,"Big wheel win!")},
    {label:"‚≠ê +2 stickers",apply:()=>{addSticker("Wheel win!");addSticker("Wheel win!");}},
    {label:"üéÆ Jumping Elf boost: +1 life",apply:()=>{gameBoost.life=1;$("wheelNote").textContent="Next Jumping Elf starts with +1 life!";}},
    {label:"üéÆ Jumping Elf boost: slow obstacles",apply:()=>{gameBoost.slow=1;$("wheelNote").textContent="Next Jumping Elf has slower obstacles!";}},
    {label:"ü™ô +5 coins",apply:()=>addCoins(5,"Wheel win!")},
    {label:"‚≠ê Surprise sticker",apply:()=>addSticker("Surprise!")}
  ];
  function wheelDone(){ ensureDaily(); return get(KEYS.wheelDone,"0")==="1"; }
  function setWheelDone(v){ set(KEYS.wheelDone,v?"1":"0"); }
  function renderWheelStatus(){
    const done=wheelDone();
    $("wheelStatus").textContent=done?"Spin Used Today":"Spin Available";
    $("wheelStatus").classList.toggle("on",!done);
    $("spinBtn").disabled=done;
  }
  let wheelRot=0;

  // Advent (simplified so it always shows grid)
  const ADVENT_SURPRISES=[
    "Jingles fact: Reindeer can see UV light! ü¶å",
    "Bells says: do 20 seconds of silly dancing üíÉ",
    "Bonus: ü™ô +5 coins!",
    "Bonus: ü™ô +10 coins!",
    "Bonus: ‚≠ê +1 sticker!",
    "Bonus: ‚≠ê +2 stickers!",
    "Draw a candy cane ‚úçÔ∏è",
    "Tell someone one nice thing üíõ",
    "Make a paper snowflake ‚úÇÔ∏è‚ùÑÔ∏è",
    "Hide a tiny note for someone üìù",
  ];
  function readAdvent(){ try{return JSON.parse(get(KEYS.advent,'{"open":[]}'))||{open:[]};}catch{return{open:[]};} }
  function writeAdvent(o){ set(KEYS.advent,JSON.stringify(o)); }
  function canOpenDoor(day){
    // ‚úÖ now just checks against today‚Äôs date (works in any month)
    const todayDate=new Date().getDate();
    return day<=todayDate;
  }
  function renderAdventGrid(){
    const grid=$("adventGrid"); grid.innerHTML="";
    const data=readAdvent();
    const opened=new Set((data.open||[]).map(Number));
    const today=new Date().getDate();

    $("adventHint").textContent=`Open doors 1‚Äì24 up to today‚Äôs date (${today}).`;

    for(let d=1;d<=24;d++){
      const btn=document.createElement("button");
      btn.type="button";
      btn.className="door";
      btn.textContent=String(d);

      const ok=canOpenDoor(d);
      if(!ok) btn.classList.add("locked");
      if(opened.has(d)) btn.classList.add("open");

      const s=document.createElement("small");
      s.textContent=opened.has(d)?"Opened":(ok?"Tap":"Locked");
      btn.appendChild(s);

      btn.addEventListener("click",()=>{
        if(!canOpenDoor(d)){ beep(180,120,"square"); return; }
        if(!opened.has(d)){
          opened.add(d);
          writeAdvent({open:[...opened].sort((a,b)=>a-b)});
        }
        const idx=(hashStr(todayKey()+"|door|"+d)%ADVENT_SURPRISES.length);
        const prize=ADVENT_SURPRISES[idx];
        $("adventOut").textContent=`Door ${d}: ${prize}`;

        if(prize.includes("+5 coins")) addCoins(5,"Advent bonus!");
        if(prize.includes("+10 coins")) addCoins(10,"Advent bonus!");
        if(prize.includes("+1 sticker")) addSticker("Advent bonus!");
        if(prize.includes("+2 stickers")){addSticker("Advent bonus!");addSticker("Advent bonus!");}

        renderAdventGrid();
        beep(920,60,"sine");
      });
      grid.appendChild(btn);
    }
    $("adventOut").textContent="Pick a door!";
  }

  // Fun bits
  const JOKES=[/* unchanged */"What do elves learn in school? The elf-abet! üéì","Why did the ornament go to school? To get a little brighter! ‚ú®","What do snowmen eat for breakfast? Ice Krispies! ü•£","Why is Santa so good at karate? He has a black belt! ü•ã","What do you call a cat on the beach at Christmas? Sandy Claws! üêæ"];
  const RIDDLES=[{q:"I‚Äôm full of holes but I can still hold water. What am I?",a:"A sponge üßΩ"},{q:"What has to be broken before you can use it?",a:"An egg ü•ö"},{q:"What has hands but can‚Äôt clap?",a:"A clock ‚è∞"},{q:"What goes up but never comes down?",a:"Your age üéÇ"}];
  const SURPRISES=["Jingles says: do a tiny happy dance! üíÉ","Bells says: find something green! üíö","Jingles says: tell someone ‚Äúthank you‚Äù! üôè","Bells says: make a funny face! üòú","Jingles says: tip-toe like an elf for 10 steps! üßù"];

  // Hidden admin: 5 second long press
  if(!get(KEYS.pin,"")) set(KEYS.pin,"1234");

  function showPinPanel(){
    $("pinInput").value=""; $("pinErr").textContent="";
    openBackdrop(pinBackdrop);
    setTimeout(()=>{try{$("pinInput").focus();}catch{}},120);
  }
  function showAdmin(){
    $("adminMsg").value=get(KEYS.msgDefault,"");
    $("backupBox").value="";
    openBackdrop(adminBackdrop);
    adminArmTimeout();
  }

  const secretZone=$("secret-zone");
  const SECRET_HOLD_MS=5000;
  let secretPressTimer=null;

  function startSecretPress(e){
    if(e) e.preventDefault();
    if(secretPressTimer) return;
    secretPressTimer=setTimeout(()=>{
      secretPressTimer=null;
      beep(880,70,"sine");
      showPinPanel();
    },SECRET_HOLD_MS);
  }
  function cancelSecretPress(){
    if(secretPressTimer){ clearTimeout(secretPressTimer); secretPressTimer=null; }
  }
  secretZone.addEventListener("mousedown",startSecretPress);
  secretZone.addEventListener("mouseup",cancelSecretPress);
  secretZone.addEventListener("mouseleave",cancelSecretPress);
  secretZone.addEventListener("touchstart",e=>startSecretPress(e),{passive:false});
  secretZone.addEventListener("touchend",()=>cancelSecretPress(),{passive:true});
  secretZone.addEventListener("touchcancel",()=>cancelSecretPress(),{passive:true});

  let panicCount=0, panicTimer=0;
  $("panic-zone").addEventListener("click",()=>{
    panicCount++; clearTimeout(panicTimer);
    panicTimer=setTimeout(()=>panicCount=0,900);
    if(panicCount>=3){
      panicCount=0;
      [extrasBackdrop,wheelBackdrop,adventBackdrop,gameBackdrop,pinBackdrop,adminBackdrop,
       gamesHubBackdrop,presentBackdrop,memoryBackdrop,snowBackdrop,runnerBackdrop,treeBackdrop].forEach(closeBackdrop);
      beep(220,140,"square");
    }
  });

  let adminTimeout=0;
  function adminArmTimeout(){
    clearTimeout(adminTimeout);
    adminTimeout=setTimeout(()=>closeBackdrop(adminBackdrop),45000);
  }
  adminBackdrop.addEventListener("mousemove",adminArmTimeout);
  adminBackdrop.addEventListener("touchstart",adminArmTimeout,{passive:true});
  adminBackdrop.addEventListener("keydown",adminArmTimeout);

  // Jumping Elf game + other games: (unchanged from previous version, apart from using helpers)
  /* -------------- JUMPING ELF, PRESENT CATCHER, MEMORY MATCH, SNOWBALL POP,
     CANDY CANE RUNNER & TREE GAME CODE HERE (identical to previous message) --------------
     For brevity in this message, I‚Äôve kept this comment ‚Äì in your file, you
     already have that whole block; keep it as-is under this line.
  */

  // Due to message length, I‚Äôm not re-pasting the entire game block again,
  // but you can safely keep your existing <script> game code from the
  // previous version below this point ‚Äî none of that needs to change
  // for the three fixes you asked about.

})();
</script>
</body>
</html>
